<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NestCheck — {{ result.address }}</title>

  <!-- Open Graph for link previews -->
  <meta property="og:title" content="NestCheck — {{ result.address }}">
  <meta property="og:description" content="{{ result.verdict }} · Score: {{ result.final_score }}/100">
  <meta property="og:type" content="article">
  <meta name="description" content="{{ result.verdict }} · Score: {{ result.final_score }}/100 — NestCheck evaluation snapshot">

  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #1a1a2e;
      background: #f0f2f5;
    }

    /* --- NAV --- */
    nav {
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      padding: 14px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav .logo {
      font-size: 1.35em;
      font-weight: 700;
      color: #16213e;
      text-decoration: none;
    }
    nav .logo span { color: #0f3460; }
    nav a.nav-link {
      color: #555;
      text-decoration: none;
      font-size: 0.95em;
      font-weight: 500;
      margin-left: 20px;
    }
    nav a.nav-link:hover { color: #0f3460; }

    /* --- SHARE BAR --- */
    .share-bar {
      max-width: 800px;
      margin: 20px auto 0;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .share-bar .snapshot-meta {
      font-size: 0.85em;
      color: #888;
    }
    .share-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #0f3460;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 0.88em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .share-btn:hover { background: #16213e; }
    .share-btn.copied {
      background: #065f46;
    }

    /* --- REPORT CONTAINER --- */
    .report {
      max-width: 800px;
      margin: 16px auto 60px;
      padding: 0 24px;
    }

    /* --- VERDICT HEADER --- */
    .verdict-card {
      background: #fff;
      border-radius: 14px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      text-align: center;
    }
    .verdict-address {
      font-size: 0.9em;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 12px;
    }
    .verdict-text {
      font-size: 1.4em;
      font-weight: 700;
      color: #16213e;
      margin-bottom: 20px;
    }
    .score-circle {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0f3460, #16213e);
      color: #fff;
      margin-bottom: 12px;
    }
    .score-circle .number {
      font-size: 2.4em;
      font-weight: 800;
      line-height: 1;
    }
    .score-circle .label {
      font-size: 0.72em;
      opacity: 0.8;
      margin-top: 2px;
    }
    .score-failed .score-circle {
      background: linear-gradient(135deg, #7f1d1d, #991b1b);
    }
    .percentile-label {
      font-size: 0.9em;
      color: #666;
      margin-top: 4px;
    }
    .final-score-text {
      font-size: 1.05em;
      font-weight: 700;
      color: #0f3460;
      margin-top: 8px;
    }

    /* --- REPORT SECTION --- */
    .report-section {
      background: #fff;
      border-radius: 12px;
      padding: 24px 28px;
      margin-bottom: 20px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.04);
    }
    .report-section h2 {
      font-size: 1.15em;
      color: #16213e;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f2f5;
    }
    .section-empty {
      color: #888;
      font-style: italic;
      font-size: 0.92em;
    }

    /* --- COLLAPSIBLE SECTIONS --- */
    .collapsible-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }
    .collapsible-toggle h2 { cursor: pointer; flex: 1; }
    .collapse-icon {
      font-size: 0.85em;
      color: #888;
      transition: transform 0.2s;
      flex-shrink: 0;
      margin-left: 8px;
    }
    .collapsible-body {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .collapsible-body.collapsed {
      max-height: 0;
    }

    /* --- PLACE ITEMS --- */
    .place-item {
      padding: 12px 0;
      border-bottom: 1px solid #f5f5f5;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .place-item:last-child { border-bottom: none; }
    .place-name { font-weight: 600; color: #1a1a2e; }
    .place-meta { font-size: 0.88em; color: #777; margin-top: 2px; }
    .place-time {
      font-weight: 600;
      font-size: 0.9em;
      color: #0f3460;
      white-space: nowrap;
      padding-left: 16px;
    }

    /* --- STATUS BADGES --- */
    .badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }
    .badge-pass { background: #d1fae5; color: #065f46; }
    .badge-borderline { background: #fff3e0; color: #e65100; }
    .badge-fail { background: #fee2e2; color: #991b1b; }
    .badge-great { background: #d1fae5; color: #065f46; }
    .badge-ok { background: #fff3cd; color: #856404; }
    .badge-painful { background: #fee2e2; color: #991b1b; }

    /* --- CHECK ITEMS --- */
    .check-row {
      display: flex;
      align-items: flex-start;
      padding: 10px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .check-row:last-child { border-bottom: none; }
    .check-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75em;
      font-weight: 700;
      flex-shrink: 0;
      margin-right: 12px;
      margin-top: 1px;
    }
    .check-pass { background: #d1fae5; color: #065f46; }
    .check-fail { background: #fee2e2; color: #991b1b; }
    .check-unknown { background: #fef3c7; color: #92400e; }
    .check-text { flex: 1; }
    .check-label { font-weight: 600; font-size: 0.95em; color: #1a1a2e; }
    .check-detail { font-size: 0.88em; color: #666; }

    /* --- PROXIMITY BAND ITEMS --- */
    .proximity-item {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .proximity-neutral { background: #f8f9fa; border-left: 3px solid #e2e8f0; }
    .proximity-notable { background: #fffbeb; border-left: 3px solid #f59e0b; }
    .proximity-very_close { background: #fef2f2; border-left: 3px solid #ef4444; }
    .proximity-name {
      font-weight: 600;
      font-size: 0.95em;
      color: #1e293b;
    }
    .proximity-detail {
      color: #64748b;
      font-size: 0.9em;
      margin-top: 4px;
      line-height: 1.5;
    }

    /* --- SCORE ROWS --- */
    .score-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .score-row:last-child { border-bottom: none; }
    .score-info { flex: 1; }
    .score-name { font-weight: 600; font-size: 0.95em; color: #1a1a2e; }
    .score-detail { font-size: 0.85em; color: #777; margin-top: 2px; }
    .score-pts {
      font-weight: 700;
      font-size: 1em;
      color: #0f3460;
      white-space: nowrap;
      padding-left: 16px;
    }

    /* --- SCORE BAR --- */
    .score-bar-container {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 2px solid #f0f2f5;
    }
    .score-bar-bg {
      width: 100%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 5px;
      overflow: hidden;
    }
    .score-bar-fill {
      height: 100%;
      border-radius: 5px;
      background: #0f3460;
      transition: width 0.6s ease;
    }
    .score-bar-label {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 0.85em;
      color: #888;
    }

    /* --- LEGEND --- */
    .score-legend {
      background: #f8f9fb;
      border-radius: 8px;
      padding: 16px 20px;
      margin-top: 16px;
    }
    .score-legend h3 {
      font-size: 0.88em;
      color: #555;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .legend-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.88em;
      padding: 4px 0;
      color: #555;
    }
    .legend-row .cat { font-weight: 500; }
    .legend-row .pts { color: #0f3460; font-weight: 600; }

    /* --- MISSING INFO --- */
    .missing-section {
      background: #fffbeb;
      border: 1px solid #fde68a;
      border-radius: 10px;
      padding: 20px 24px;
    }
    .missing-section h2 {
      color: #92400e;
      border-bottom-color: #fde68a;
    }
    .missing-item {
      display: flex;
      align-items: flex-start;
      padding: 8px 0;
      gap: 10px;
    }
    .missing-bullet {
      color: #d97706;
      font-weight: 700;
      flex-shrink: 0;
    }
    .missing-text { font-size: 0.92em; color: #78350f; }

    /* --- PARK SUBSCORES --- */
    .subscore-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    .subscore-card {
      background: #f8f9fb;
      border-radius: 6px;
      padding: 8px 12px;
    }
    .subscore-label {
      font-size: 0.78em;
      color: #666;
      text-transform: uppercase;
      font-weight: 600;
    }
    .subscore-label .est { color: #d97706; }
    .subscore-value {
      font-weight: 700;
      color: #16213e;
      font-size: 1em;
    }
    .subscore-reason {
      font-size: 0.78em;
      color: #888;
      margin-top: 2px;
    }

    /* --- HUB ROW --- */
    .hub-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .hub-row:last-child { border-bottom: none; }
    .hub-info { flex: 1; }
    .hub-name { font-weight: 600; font-size: 0.95em; color: #1a1a2e; }
    .hub-detail { font-size: 0.85em; color: #777; margin-top: 2px; }
    .hub-right {
      display: flex;
      align-items: center;
      gap: 10px;
      padding-left: 16px;
    }
    .hub-time { font-weight: 600; color: #0f3460; font-size: 0.95em; white-space: nowrap; }

    /* --- WALK SCORE PILLS --- */
    .walkscore-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid #f0f0f0;
    }
    .walkscore-pill {
      flex: 1;
      min-width: 100px;
      background: #f8f9fb;
      padding: 10px 12px;
      border-radius: 8px;
      text-align: center;
    }
    .walkscore-pill .ws-label {
      font-size: 0.72em;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .walkscore-pill .ws-value {
      font-size: 1.5em;
      font-weight: 700;
      color: #16213e;
    }
    .walkscore-pill .ws-desc {
      font-size: 0.78em;
      color: #666;
    }

    /* --- DATA UNAVAILABLE --- */
    .data-unavailable {
      color: #888;
      font-style: italic;
      font-size: 0.9em;
      padding: 8px 0;
    }

    /* --- CTA BANNER (snapshot) --- */
    .snapshot-cta {
      background: #fff;
      border: 2px solid #0f3460;
      border-radius: 12px;
      padding: 24px 28px;
      margin-bottom: 24px;
      text-align: center;
    }
    .snapshot-cta h3 {
      font-size: 1.1em;
      color: #16213e;
      margin-bottom: 6px;
    }
    .snapshot-cta p {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 14px;
    }
    .snapshot-cta a {
      display: inline-block;
      padding: 10px 24px;
      background: #0f3460;
      color: #fff;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.92em;
      text-decoration: none;
      transition: background 0.2s;
    }
    .snapshot-cta a:hover { background: #16213e; }

    /* --- DISCLAIMER / FOOTER --- */
    .disclaimer {
      max-width: 800px;
      margin: 0 auto 40px;
      padding: 20px 24px;
      font-size: 0.82em;
      color: #999;
      line-height: 1.6;
    }
    .disclaimer strong { color: #777; }

    footer {
      border-top: 1px solid #e0e0e0;
      padding: 24px;
      text-align: center;
      font-size: 0.85em;
      color: #999;
      background: #fff;
    }

    /* --- BUILDER DEBUG --- */
    .builder-debug {
      max-width: 800px;
      margin: 16px auto;
      padding: 12px 20px;
      background: #1a1a2e;
      color: #a5f3a5;
      border-radius: 8px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.78em;
      line-height: 1.5;
    }
    .builder-debug summary {
      cursor: pointer;
      font-weight: 700;
      color: #fbbf24;
    }
    .builder-debug pre {
      margin-top: 8px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 640px) {
      .verdict-card { padding: 24px 20px; }
      .report-section { padding: 20px; }
      .score-circle { width: 100px; height: 100px; }
      .score-circle .number { font-size: 2em; }
      .subscore-grid { grid-template-columns: 1fr 1fr; }
      .share-bar { flex-direction: column; align-items: stretch; }
      .share-btn { justify-content: center; }
      .hub-row { flex-direction: column; align-items: flex-start; gap: 4px; }
      .hub-right { padding-left: 0; }
    }

    /* --- PRINT --- */
    @media print {
      nav, .share-bar, .snapshot-cta, .builder-debug, footer { display: none; }
      body { background: #fff; }
      .report { margin: 0 auto; }
      .report-section { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; }
      .verdict-card { box-shadow: none; border: 1px solid #ddd; }
    }
  </style>
</head>
<body>

<!-- NAV -->
<nav>
  <a href="/" class="logo">Nest<span>Check</span></a>
  <div>
    <a href="/" class="nav-link">Evaluate an address</a>
  </div>
</nav>

<!-- SHARE + EXPORT BAR -->
<div class="share-bar">
  <div class="snapshot-meta">
    Snapshot created {{ snapshot.created_at[:10] }}
    {% if snapshot.view_count > 1 %} · Viewed {{ snapshot.view_count }} times{% endif %}
  </div>
  <div style="display: flex; gap: 8px; align-items: center;">
    <button class="share-btn" id="shareBtn" onclick="copyShareLink()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
      <span id="shareBtnText">Copy share link</span>
    </button>
    <a href="/api/snapshot/{{ snapshot_id }}/json" class="share-btn" style="text-decoration: none; background: #334155;">JSON</a>
    <a href="/api/snapshot/{{ snapshot_id }}/csv" class="share-btn" style="text-decoration: none; background: #334155;">CSV</a>
  </div>
</div>

{% if is_builder %}
<!-- BUILDER DEBUG (only visible in builder mode) -->
<details class="builder-debug">
  <summary>Builder Debug — Snapshot {{ snapshot_id }}</summary>
  <pre>snapshot_id: {{ snapshot_id }}
address_input: {{ snapshot.address_input }}
address_norm: {{ snapshot.address_norm }}
created_at: {{ snapshot.created_at }}
view_count: {{ snapshot.view_count }}
final_score: {{ result.final_score }}
passed_tier1: {{ result.passed_tier1 }}
coordinates: {{ result.coordinates }}
tier2_raw: {{ result.tier2_score }}/{{ result.tier2_max }}
tier2_normalized: {{ result.tier2_normalized }}
tier3_bonus: {{ result.tier3_bonus }}</pre>
</details>
{% endif %}

{% set is_snapshot = true %}
{% include '_result_sections.html' %}

<!-- FOOTER -->
<footer>
  NestCheck &middot; Decision support for families optimizing daily life.
</footer>

<script>
  function copyShareLink() {
    var url = window.location.href;
    navigator.clipboard.writeText(url).then(function() {
      var btn = document.getElementById('shareBtn');
      var txt = document.getElementById('shareBtnText');
      btn.classList.add('copied');
      txt.textContent = 'Copied!';
      setTimeout(function() {
        btn.classList.remove('copied');
        txt.textContent = 'Copy share link';
      }, 2000);

      // Track share event
      fetch('/api/event', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          event_type: 'snapshot_shared',
          snapshot_id: '{{ snapshot_id }}'
        })
      }).catch(function() {}); // fire-and-forget
    });
  }

  function toggleSection(el) {
    var body = el.nextElementSibling;
    var icon = el.querySelector('.collapse-icon');
    if (body.classList.contains('collapsed')) {
      body.classList.remove('collapsed');
      icon.innerHTML = '&#9660;';
    } else {
      body.classList.add('collapsed');
      icon.innerHTML = '&#9654;';
    }
  }
</script>

</body>
</html>
