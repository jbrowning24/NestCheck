{% extends "_base.html" %}

{% block title %}NestCheck — {{ result.address }}{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/report.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/snapshot.css') }}">
{% endblock %}

{% block meta_description %}
  <meta name="description" content="{{ result.verdict }} · Score: {{ result.final_score }}/100 — NestCheck evaluation for {{ result.address }}">
{% endblock %}

{% block og_tags %}
  <meta property="og:title" content="NestCheck — {{ result.address }}">
  <meta property="og:description" content="{{ result.verdict }} · Score: {{ result.final_score }}/100">
  <meta property="og:type" content="article">
  <meta property="og:url" content="{{ request.url }}">
{% endblock %}

{% block nav_links %}
  <a href="/" class="nav-link">Evaluate an address</a>
{% endblock %}

{% block content %}

<div class="report-layout">
  <div class="report-layout__main">
    <!-- SHARE + EXPORT BAR -->
    <div class="share-bar">
      <div class="snapshot-meta">
        Snapshot created {{ snapshot.created_at[:10] }}
        {% if snapshot.view_count > 1 %} · Viewed {{ snapshot.view_count }} times{% endif %}
      </div>
      <div class="share-actions">
        <button class="share-btn" id="shareBtn" onclick="copyShareLink(this)">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
          <span id="shareBtnText">Copy share link</span>
        </button>
        <a href="/api/snapshot/{{ snapshot_id }}/json" class="share-btn share-btn--secondary">JSON</a>
        <a href="/api/snapshot/{{ snapshot_id }}/csv" class="share-btn share-btn--secondary">CSV</a>
      </div>
    </div>

    {% set is_snapshot = true %}
    {% include '_result_sections.html' %}
  </div>

  <aside class="report-layout__rail">
    {% include '_report_rail.html' %}
  </aside>
</div>

{% endblock %}

{% block scripts %}
<script>
  // CSRF token from <meta> tag — included as X-CSRFToken header on every POST.
  function csrfToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  }

  function copyShareLink(triggerEl) {
    var url = window.location.href;
    navigator.clipboard.writeText(url).then(function() {
      var btn = triggerEl || document.getElementById('shareBtn');
      var txt = btn.querySelector('span') || btn;
      var origText = txt.textContent;
      btn.classList.add('copied');
      txt.textContent = 'Copied!';
      setTimeout(function() {
        btn.classList.remove('copied');
        txt.textContent = origText;
      }, 2000);

      // Track share event
      fetch('/api/event', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken()},
        body: JSON.stringify({
          event_type: 'snapshot_shared',
          snapshot_id: '{{ snapshot_id }}'
        })
      }).catch(function() {}); // fire-and-forget
    });
  }

  function toggleSection(el) {
    var body = el.nextElementSibling;
    var icon = el.querySelector('.collapse-icon');
    if (body.classList.contains('collapsed')) {
      body.classList.remove('collapsed');
      icon.innerHTML = '&#9660;';
    } else {
      body.classList.add('collapsed');
      icon.innerHTML = '&#9654;';
    }
  }
</script>
<script src="{{ url_for('static', filename='js/neighborhood-map.js') }}"></script>
<script src="{{ url_for('static', filename='js/section-nav.js') }}"></script>
{% endblock %}
