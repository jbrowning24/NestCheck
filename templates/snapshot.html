{% extends "_base.html" %}

{% block title %}NestCheck — {{ result.address }}{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/report.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/snapshot.css') }}">
{% endblock %}

{% block meta_description %}
  {% if is_preview %}
  <meta name="description" content="Health &amp; safety proximity results for {{ result.address }} — NestCheck">
  {% else %}
  <meta name="description" content="{{ result.verdict }} · Score: {{ result.final_score }}/100 — NestCheck evaluation for {{ result.address }}">
  {% endif %}
{% endblock %}

{% block og_tags %}
  {% if is_preview %}
  <meta property="og:title" content="NestCheck — Health Check for {{ result.address }}">
  <meta property="og:description" content="Health &amp; safety proximity results for {{ result.address }}">
  {% else %}
  <meta property="og:title" content="NestCheck — {{ result.address }}">
  <meta property="og:description" content="{{ result.verdict }} · Score: {{ result.final_score }}/100">
  {% endif %}
  <meta property="og:type" content="article">
  <meta property="og:url" content="{{ request.url }}">
  {% if not is_preview %}
  <meta property="og:image" content="{{ url_for('static', filename='images/og-default.png', _external=True) }}">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  {% endif %}
{% endblock %}

{% block nav_links %}
  <a href="/" class="nav-link">Evaluate an address</a>
  {% if is_builder %}
    <a href="/builder/dashboard" class="nav-link">Dashboard</a>
  {% endif %}
{% endblock %}

{% block content %}

{% if is_builder %}
<details class="error-diagnostic">
  <summary>Builder diagnostic</summary>
  <pre>{{ {
    "snapshot_id": snapshot_id,
    "snapshot_url": request.url,
    "address": result.address,
    "created_at": snapshot.created_at,
    "view_count": snapshot.view_count,
    "walk_scores": result.walk_scores if result.walk_scores is defined else none,
    "transit_access": result.transit_access if result.transit_access is defined else none,
  } | tojson(indent=2) }}</pre>
</details>
{% endif %}

<div class="report-layout">
  {% set is_snapshot = true %}
  {% include '_result_sections.html' %}

  <aside class="report-layout__rail">
    {% include '_report_rail.html' %}
  </aside>
</div>

{% endblock %}

{% block scripts %}
<script>
  // CSRF token from <meta> tag — included as X-CSRFToken header on every POST.
  function csrfToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  }

  function copyShareLink(triggerEl) {
    var url = window.location.href;
    navigator.clipboard.writeText(url).then(function() {
      var btn = triggerEl || document.getElementById('shareBtn');
      var txt = btn.querySelector('span') || btn;
      var origText = txt.textContent;
      btn.classList.add('copied');
      txt.textContent = 'Copied!';
      var feedback = document.getElementById('copyFeedback');
      if (feedback) feedback.textContent = 'Link copied to clipboard';
      setTimeout(function() {
        btn.classList.remove('copied');
        txt.textContent = origText;
        if (feedback) feedback.textContent = '';
      }, 2000);

      // Track share event
      fetch('/api/event', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken()},
        body: JSON.stringify({
          event_type: 'snapshot_shared',
          snapshot_id: '{{ snapshot_id }}'
        })
      }).catch(function() {}); // fire-and-forget
    });
  }

  function nativeShare() {
    navigator.share({
      title: {{ result.address | tojson }},
      text: {{ (result.verdict ~ ' · Score: ' ~ result.final_score ~ '/100') | tojson }},
      url: window.location.href
    }).then(function() {
      // Track share event
      fetch('/api/event', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken()},
        body: JSON.stringify({
          event_type: 'snapshot_shared',
          snapshot_id: '{{ snapshot_id }}'
        })
      }).catch(function() {});
    }).catch(function(err) {
      // User cancelled — ignore
      if (err.name !== 'AbortError') {
        console.warn('Share failed:', err);
      }
    });
  }

  // Feature detection: show native share button if Web Share API is available
  (function() {
    if (navigator.share) {
      var btn = document.getElementById('nativeShareBtn');
      if (btn) btn.style.display = '';
    }
  })();

  function toggleSection(el) {
    var body = el.nextElementSibling;
    var icon = el.querySelector('.collapse-icon');
    if (body.classList.contains('collapsed')) {
      body.classList.remove('collapsed');
      if (icon) icon.classList.add('is-expanded');
    } else {
      body.classList.add('collapsed');
      if (icon) icon.classList.remove('is-expanded');
    }
    var isExpanded = !body.classList.contains('collapsed');
    el.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
  }

  // Keyboard support for collapsible toggles
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
      var toggle = e.target.closest('.collapsible-toggle');
      if (toggle) {
        e.preventDefault();
        toggle.click();
      }
    }
  });

  // NES-132: Preview checkout flow — bind via data attribute
  (function() {
    var btn = document.querySelector('.preview-unlock-btn[data-snapshot-id]');
    if (!btn) return;
    btn.addEventListener('click', function() {
      var snapshotId = btn.dataset.snapshotId;
      btn.disabled = true;
      btn.textContent = 'Redirecting to checkout...';

      fetch('/checkout/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrfToken()
        },
        body: 'snapshot_id=' + encodeURIComponent(snapshotId)
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.checkout_url) {
          window.location.href = data.checkout_url;
        } else {
          btn.disabled = false;
          btn.textContent = 'Unlock full report \u2014 $9';
          alert(data.error || 'Something went wrong. Please try again.');
        }
      })
      .catch(function() {
        btn.disabled = false;
        btn.textContent = 'Unlock full report \u2014 $9';
      });
    });
  })();
</script>

{# NES-132: Payment pending — poll lightweight status endpoint for unlock #}
{% if payment_pending is defined and payment_pending %}
<script>
  (function() {
    var attempts = 0;
    var maxAttempts = 15;
    var interval = setInterval(function() {
      attempts++;
      if (attempts >= maxAttempts) {
        clearInterval(interval);
        var banner = document.querySelector('.preview-health-banner');
        if (banner) {
          banner.innerHTML = '<div class="preview-health-title">Payment received</div>' +
            '<div class="preview-health-status">Please refresh the page to see your full report.</div>';
        }
        return;
      }
      // Lightweight JSON check — avoids full page reloads that inflate view_count
      fetch('/api/snapshot/{{ snapshot_id }}/status')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.unlocked) {
            clearInterval(interval);
            window.location.href = '/s/{{ snapshot_id }}';
          }
        })
        .catch(function() {}); // Swallow network errors, retry on next interval
    }, 2000);
  })();
</script>
{% endif %}

<script src="{{ url_for('static', filename='js/neighborhood-map.js') }}"></script>
<script src="{{ url_for('static', filename='js/section-nav.js') }}"></script>
{% endblock %}
