{% extends "_base.html" %}

{% block title %}NestCheck — Know Before You Move{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/report.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
{% endblock %}

{% block meta_description %}
  {% if result %}
  <meta name="description" content="{{ result.verdict }} · Score: {{ result.final_score }}/100 — NestCheck evaluation for {{ result.address }}">
  {% else %}
  <meta name="description" content="Enter any address and get a detailed evaluation of walkability, parks, transit, schools, and safety. Know before you move.">
  {% endif %}
{% endblock %}

{% block og_tags %}
  {% if result %}
  <meta property="og:title" content="NestCheck — {{ result.address }}">
  <meta property="og:description" content="{{ result.verdict }} · Score: {{ result.final_score }}/100">
  {% else %}
  <meta property="og:title" content="NestCheck — Know Before You Move">
  <meta property="og:description" content="Enter any address and get a detailed evaluation of walkability, parks, transit, schools, and safety.">
  {% endif %}
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ request.host_url }}">
{% endblock %}

{% block nav_links %}
  {% if is_builder %}
    <a href="/builder/dashboard" class="nav-link nav-link--builder">Dashboard</a>
  {% endif %}
{% endblock %}

{% block content %}

<!-- LOADING OVERLAY -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-brand">
    <svg class="loading-mark" viewBox="0 0 48 48" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M8 22 L24 8 L40 22 V40 A2 2 0 0 1 38 42 H10 A2 2 0 0 1 8 40 Z"/>
      <rect x="18" y="28" width="12" height="14" rx="1"/>
    </svg>
  </div>
  <div class="loading-text">Evaluating this address...</div>
  <div class="loading-progress">
    <div class="loading-progress-fill" id="progressFill"></div>
  </div>
  <div class="loading-sub">Checking parks, transit, schools, safety, and more.</div>
  <div class="loading-patience" id="loadingPatience">This usually takes 30–60 seconds.</div>
</div>

{% if not result %}
{# ============================================================ #}
{#                     LANDING PAGE                              #}
{# ============================================================ #}
<div class="landing-hero-band">

  <div class="hero">
    <h1>Know before you move.</h1>
    <p class="tagline">Evaluate any U.S. address for walkability, green space, transit, schools, and daily-life quality — instant results, shareable link.</p>
  </div>

  <div class="search-section" id="evaluate">
    {% if error %}
      <div class="error-banner">
        <strong>Could not evaluate address</strong>
        {{ error }}
        {% if request_id %}
          <div class="error-ref">ref: {{ request_id }}</div>
        {% endif %}
      </div>
      {% if is_builder and error_detail %}
      <details class="error-diagnostic">
        <summary>Builder diagnostic</summary>
        <pre>{{ error_detail | tojson(indent=2) }}</pre>
      </details>
      {% endif %}
    {% endif %}
    <form method="POST" id="evalForm">
      <div class="search-box">
        <input type="text" name="address" id="address-input" placeholder="Enter any U.S. address..." value="{{ address }}" required>
        <button type="submit" id="evalBtn">Evaluate</button>
      </div>
    </form>
  </div>

  <div class="why-block">
    <p><strong>Listings show rooms and photos.</strong> They don't tell you if you can walk to a good park, how far the highway is, or whether there's a decent grocery nearby.</p>
    <p>NestCheck evaluates daily-life quality at any U.S. address — so you know before you visit or sign. For families, renters, and homebuyers choosing where to live.</p>
  </div>

</div>{# /.landing-hero-band #}

<div class="features">
  <div class="feature-card">
    <h3>Green Escape</h3>
    <p>Parks, trails, and nature within walking distance. Scored by quality and accessibility.</p>
  </div>
  <div class="feature-card">
    <h3>Urban Access</h3>
    <p>Transit options, commute times, and connectivity to major hubs.</p>
  </div>
  <div class="feature-card">
    <h3>Family &amp; Schools</h3>
    <p>Nearby schools, childcare, and family-friendly infrastructure.</p>
  </div>
  <div class="feature-card">
    <h3>Health &amp; Safety</h3>
    <p>Distance from highways, gas stations, and high-volume roads.</p>
  </div>
  <div class="feature-card">
    <h3>Daily Essentials</h3>
    <p>Walkable groceries, cafes, fitness — the fabric of daily life.</p>
  </div>
  <div class="feature-card">
    <h3>Final Score</h3>
    <p>One number, 0-100. Clear breakdown of how it was computed.</p>
  </div>
</div>

{% else %}
{# ============================================================ #}
{#                        EVALUATION RESULT                      #}
{# ============================================================ #}
<div class="search-section search-section--result">
  <form method="POST" id="evalForm">
    <div class="search-box">
      <input type="text" name="address" placeholder="Enter any U.S. address..." value="{{ address }}" required>
      <button type="submit" id="evalBtn">New evaluation</button>
    </div>
  </form>
</div>

{% set is_snapshot = false %}
{% include '_result_sections.html' %}
{% endif %}

{% endblock %}

{% block footer %}
<footer>
  NestCheck &middot; Livability evaluation for families and remote workers choosing where to live.
  <div class="footer-links">
    <a href="/privacy">Privacy Policy</a> &middot; <a href="/terms">Terms of Service</a>
  </div>
</footer>
{% endblock %}

{% block scripts %}
<script>
  const REQUIRE_PAYMENT = {{ 'true' if require_payment else 'false' }};

  // CSRF token from <meta> tag — included as X-CSRFToken header on every POST.
  function csrfToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  }

  (function() {
    var POLL_INTERVAL_MS = 2000;

    // Stage names from backend -> user-facing progress text + approximate percentage
    var STAGE_DISPLAY = {
      geocode:              { text: 'Locating address...',                    pct: 5  },
      analyzing:            { text: 'Analyzing neighborhood, transit, parks...', pct: 10 },
      bike_score:           { text: 'Checking bike infrastructure...',        pct: 20 },
      neighborhood:         { text: 'Analyzing nearby amenities...',          pct: 30 },
      schools:              { text: 'Finding schools and childcare...',       pct: 40 },
      urban_access:         { text: 'Calculating commute times...',           pct: 45 },
      transit_access:       { text: 'Evaluating transit options...',          pct: 50 },
      green_spaces:         { text: 'Discovering parks and trails...',        pct: 55 },
      green_escape:         { text: 'Finding your daily green escape...',     pct: 60 },
      transit_score:        { text: 'Getting transit scores...',              pct: 65 },
      walk_scores:          { text: 'Getting walkability scores...',          pct: 70 },
      tier1_checks:         { text: 'Running safety checks...',              pct: 75 },
      score_park_access:    { text: 'Calculating lifestyle scores...',        pct: 80 },
      score_third_place:    { text: 'Calculating lifestyle scores...',        pct: 82 },
      score_provisioning:   { text: 'Calculating lifestyle scores...',        pct: 84 },
      score_fitness:        { text: 'Calculating lifestyle scores...',        pct: 86 },
      score_transit_access: { text: 'Calculating lifestyle scores...',        pct: 88 },
      tier3_bonuses:        { text: 'Adding bonus points...',                 pct: 92 },
      saving:               { text: 'Saving your results...',                 pct: 97 }
    };

    function stageDisplay(stage) {
      var info = STAGE_DISPLAY[stage];
      return info ? info.text : 'Working...';
    }

    function stagePercent(stage) {
      var info = STAGE_DISPLAY[stage];
      return info ? info.pct : 0;
    }

    function setProgress(pct) {
      var fill = document.getElementById('progressFill');
      if (fill) fill.style.width = pct + '%';
    }

    function hideOverlay(overlay) {
      overlay.classList.remove('active');
      var p = document.getElementById('loadingPatience');
      if (p) p.classList.remove('visible');
    }

    function showError(msg, overlay, btn, form) {
      hideOverlay(overlay);
      btn.disabled = false;
      btn.textContent = btn.dataset.originalText || 'Evaluate';
      var existingBanner = document.querySelector('.error-banner');
      if (existingBanner) existingBanner.remove();

      var banner = document.createElement('div');
      banner.className = 'error-banner';
      banner.innerHTML = '<strong>Could not evaluate address</strong><span class="error-msg">' + msg + '</span>';

      var retryBtn = document.createElement('button');
      retryBtn.className = 'error-retry';
      retryBtn.textContent = 'Try again';
      retryBtn.addEventListener('click', function() {
        banner.remove();
        var input = document.getElementById('address-input');
        if (input) input.focus();
      });
      banner.appendChild(retryBtn);

      form.parentNode.insertBefore(banner, form);
    }

    function startPolling(jobId, overlay, loadingText, loadingSub, btn, form) {
      overlay.classList.add('active');
      loadingText.textContent = 'Evaluating this address...';
      loadingSub.textContent = 'Starting...';
      setProgress(2);

      var patienceEl = document.getElementById('loadingPatience');
      var patienceTimer = setTimeout(function() {
        if (patienceEl) patienceEl.classList.add('visible');
      }, 10000);

      function poll() {
        fetch('/job/' + jobId, { headers: { 'Accept': 'application/json' } })
          .then(function(r) {
            if (!r.ok) {
              if (r.status === 404) {
                clearTimeout(patienceTimer);
                showError('Job not found.', overlay, btn, form);
              }
              return null;
            }
            return r.json();
          })
          .then(function(data) {
            if (!data) return;
            if (data.current_stage) {
              loadingSub.textContent = stageDisplay(data.current_stage);
              setProgress(stagePercent(data.current_stage));
            }
            if (data.status === 'done' && data.snapshot_id) {
              clearTimeout(patienceTimer);
              setProgress(100);
              window.location.href = '/s/' + data.snapshot_id;
              return;
            }
            if (data.status === 'failed') {
              clearTimeout(patienceTimer);
              showError(data.error || 'Evaluation failed.', overlay, btn, form);
              return;
            }
            setTimeout(poll, POLL_INTERVAL_MS);
          })
          .catch(function(err) {
            clearTimeout(patienceTimer);
            showError('Could not check job status. Please try again. (' + err.message + ')', overlay, btn, form);
          });
      }
      poll();
    }

    // ---------------------------------------------------------------
    // submitEvaluation — POST to / with address (+ optional payment_token)
    // Used by both free and paid paths.
    // ---------------------------------------------------------------
    function submitEvaluation(address, paymentToken) {
      var form = document.getElementById('evalForm');
      var btn = document.getElementById('evalBtn');
      var overlay = document.getElementById('loadingOverlay');
      var loadingText = overlay.querySelector('.loading-text');
      var loadingSub = overlay.querySelector('.loading-sub');

      btn.disabled = true;
      btn.textContent = 'Evaluating...';
      overlay.classList.add('active');
      loadingText.textContent = 'Evaluating this address...';
      loadingSub.textContent = 'Submitting...';
      setProgress(0);

      var body = new FormData();
      body.append('address', address);
      if (paymentToken) {
        body.append('payment_token', paymentToken);
      }

      fetch('/', {
        method: 'POST',
        body: body,
        headers: { 'Accept': 'application/json', 'X-CSRFToken': csrfToken() }
      })
        .then(function(resp) { return resp.json(); })
        .then(function(data) {
          if (data.error) {
            var traceRef = data.request_id ? ' (ref: ' + data.request_id + ')' : '';
            showError(data.error + traceRef, overlay, btn, form);
          } else if (data.job_id) {
            startPolling(data.job_id, overlay, loadingText, loadingSub, btn, form);
          } else {
            showError('Unexpected response from server.', overlay, btn, form);
          }
        })
        .catch(function(err) {
          showError('Network error. Please try again. (' + err.message + ')', overlay, btn, form);
        });
    }

    // ---------------------------------------------------------------
    // Form submit handler — branches on REQUIRE_PAYMENT
    // ---------------------------------------------------------------
    document.getElementById('evalForm').addEventListener('submit', function(e) {
      e.preventDefault();
      var form = e.target;
      var address = form.querySelector('input[name="address"]').value.trim();
      if (!address) return;

      if (REQUIRE_PAYMENT) {
        // Paid path: create Stripe Checkout session, then redirect
        var btn = document.getElementById('evalBtn');
        var overlay = document.getElementById('loadingOverlay');
        var loadingSub = overlay.querySelector('.loading-sub');
        btn.disabled = true;
        btn.textContent = 'Redirecting to checkout...';
        overlay.classList.add('active');
        overlay.querySelector('.loading-text').textContent = 'Preparing checkout...';
        loadingSub.textContent = 'Please wait...';
        setProgress(0);

        var checkoutBody = new FormData();
        checkoutBody.append('address', address);

        fetch('/checkout/create', {
          method: 'POST',
          body: checkoutBody,
          headers: { 'Accept': 'application/json', 'X-CSRFToken': csrfToken() }
        })
          .then(function(resp) {
            if (!resp.ok && (resp.headers.get('content-type') || '').indexOf('application/json') === -1) {
              throw new Error('Server error (' + resp.status + ')');
            }
            return resp.json();
          })
          .then(function(data) {
            if (data.error) {
              showError(data.error, overlay, btn, form);
            } else if (data.checkout_url) {
              window.location.href = data.checkout_url;
            } else {
              showError('Unexpected response from server.', overlay, btn, form);
            }
          })
          .catch(function(err) {
            showError('Could not start checkout. Please try again. (' + err.message + ')', overlay, btn, form);
          });
      } else {
        // Free path: submit evaluation directly
        submitEvaluation(address, null);
      }
    });

    var evalBtn = document.getElementById('evalBtn');
    if (evalBtn) evalBtn.dataset.originalText = evalBtn.textContent;

    // ---------------------------------------------------------------
    // Auto-submit on return from Stripe checkout
    // ---------------------------------------------------------------
    var urlParams = new URLSearchParams(window.location.search);
    var paymentToken = urlParams.get('payment_token');
    var returnAddress = urlParams.get('address');

    if (REQUIRE_PAYMENT && paymentToken && returnAddress) {
      // Clean the URL (remove params without reload)
      window.history.replaceState({}, '', '/');
      // Pre-fill the address field
      // Note: URLSearchParams.get() already percent-decodes the value,
      // so no additional decodeURIComponent() is needed (and would break
      // addresses containing a literal '%' character).
      var addressInput = document.getElementById('address-input');
      if (addressInput) {
        addressInput.value = returnAddress;
      }
      // Auto-submit with the payment token
      submitEvaluation(returnAddress, paymentToken);
    }

    // If we landed with ?job_id= (e.g. non-JS form POST redirect), start polling
    var initialJobId = '{{ job_id or "" }}';
    if (initialJobId) {
      var overlay = document.getElementById('loadingOverlay');
      var loadingText = overlay && overlay.querySelector('.loading-text');
      var loadingSub = overlay && overlay.querySelector('.loading-sub');
      if (overlay && loadingText && loadingSub) {
        var form = document.getElementById('evalForm');
        var btn = document.getElementById('evalBtn');
        if (btn) btn.disabled = true;
        startPolling(initialJobId, overlay, loadingText, loadingSub, btn || {}, form || document.body);
      }
    }
  })();

  function copyShareLink() {
    var snapshotId = '{{ snapshot_id or "" }}';
    if (!snapshotId) return;
    var url = window.location.origin + '/s/' + snapshotId;
    navigator.clipboard.writeText(url).then(function() {
      var btn = document.getElementById('shareBtn');
      var txt = document.getElementById('shareBtnText');
      btn.classList.add('copied');
      txt.textContent = 'Copied!';
      setTimeout(function() {
        btn.classList.remove('copied');
        txt.textContent = 'Copy share link';
      }, 2000);

      // Track share event
      fetch('/api/event', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken()},
        body: JSON.stringify({
          event_type: 'snapshot_shared',
          snapshot_id: snapshotId
        })
      }).catch(function() {});
    });
  }

  function toggleSection(el) {
    var body = el.nextElementSibling;
    var icon = el.querySelector('.collapse-icon');
    if (body.classList.contains('collapsed')) {
      body.classList.remove('collapsed');
      icon.innerHTML = '&#9660;';
    } else {
      body.classList.add('collapsed');
      icon.innerHTML = '&#9654;';
    }
  }
</script>
{% endblock %}
