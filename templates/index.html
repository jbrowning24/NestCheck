<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NestCheck — Know Before You Move</title>
  {% if result %}
  <meta property="og:title" content="NestCheck — {{ result.address }}">
  <meta property="og:description" content="{{ result.verdict }} · Score: {{ result.final_score }}/100">
  {% endif %}
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #1a1a2e;
      background: #f0f2f5;
    }

    /* --- NAV --- */
    nav {
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      padding: 14px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav .logo {
      font-size: 1.35em;
      font-weight: 700;
      color: #16213e;
      text-decoration: none;
    }
    nav .logo span { color: #0f3460; }
    nav a.nav-link {
      color: #555;
      text-decoration: none;
      font-size: 0.95em;
      font-weight: 500;
      margin-left: 20px;
    }
    nav a.nav-link:hover { color: #0f3460; }

    /* --- HERO / LANDING --- */
    .hero {
      max-width: 700px;
      margin: 60px auto 0;
      text-align: center;
      padding: 0 24px;
    }
    .hero h1 {
      font-size: 2.6em;
      font-weight: 800;
      color: #16213e;
      margin-bottom: 12px;
      letter-spacing: -0.02em;
    }
    .hero .tagline {
      font-size: 1.15em;
      color: #555;
      margin-bottom: 36px;
      max-width: 520px;
      margin-left: auto;
      margin-right: auto;
    }

    /* --- FORM --- */
    .search-section {
      max-width: 640px;
      margin: 0 auto 30px;
      padding: 0 24px;
    }
    .search-box {
      display: flex;
      gap: 10px;
      background: #fff;
      padding: 8px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 2px solid #e8e8e8;
      transition: border-color 0.2s;
    }
    .search-box:focus-within {
      border-color: #0f3460;
    }
    .search-box input[type="text"] {
      flex: 1;
      padding: 14px 16px;
      border: none;
      font-size: 16px;
      background: transparent;
      outline: none;
      color: #1a1a2e;
    }
    .search-box input[type="text"]::placeholder { color: #999; }
    .search-box button {
      padding: 14px 28px;
      background: #0f3460;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .search-box button:hover { background: #16213e; }
    .search-box button:disabled {
      background: #8899aa;
      cursor: not-allowed;
    }

    /* --- FEATURES (landing) --- */
    .features {
      max-width: 700px;
      margin: 40px auto 60px;
      padding: 0 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }
    .feature-card {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #eee;
    }
    .feature-card h3 {
      font-size: 0.95em;
      color: #16213e;
      margin-bottom: 6px;
    }
    .feature-card p {
      font-size: 0.88em;
      color: #666;
      line-height: 1.5;
    }

    /* --- LOADING --- */
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.92);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .loading-overlay.active { display: flex; }

    /* --- ERROR BANNER (injected by JS on failure) --- */
    .error-banner {
      background: #fef2f2;
      border: 1px solid #fca5a5;
      border-radius: 10px;
      padding: 16px 20px;
      margin-bottom: 16px;
      color: #991b1b;
      line-height: 1.5;
    }
    .error-banner strong {
      display: block;
      margin-bottom: 4px;
      font-size: 1em;
    }
    .error-banner .error-msg {
      display: block;
      font-size: 0.92em;
      color: #7f1d1d;
    }
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e0e0e0;
      border-top-color: #0f3460;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      margin-top: 20px;
      font-size: 1.05em;
      color: #333;
      font-weight: 500;
    }
    .loading-sub {
      margin-top: 8px;
      font-size: 0.88em;
      color: #888;
    }

    /* --- ERROR --- */
    .error-banner {
      max-width: 640px;
      margin: 0 auto 20px;
      padding: 16px 20px;
      background: #fef2f2;
      border: 1px solid #fca5a5;
      border-radius: 10px;
      color: #991b1b;
      font-size: 0.95em;
    }
    .error-banner strong { display: block; margin-bottom: 4px; }

    /* --- REPORT CONTAINER --- */
    .report {
      max-width: 800px;
      margin: 30px auto 60px;
      padding: 0 24px;
    }

    /* --- VERDICT HEADER --- */
    .verdict-card {
      background: #fff;
      border-radius: 14px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      text-align: center;
    }
    .verdict-address {
      font-size: 0.9em;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 12px;
    }
    .verdict-text {
      font-size: 1.4em;
      font-weight: 700;
      color: #16213e;
      margin-bottom: 20px;
    }
    .score-circle {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0f3460, #16213e);
      color: #fff;
      margin-bottom: 12px;
    }
    .score-circle .number {
      font-size: 2.4em;
      font-weight: 800;
      line-height: 1;
    }
    .score-circle .label {
      font-size: 0.72em;
      opacity: 0.8;
      margin-top: 2px;
    }
    .score-failed .score-circle {
      background: linear-gradient(135deg, #7f1d1d, #991b1b);
    }
    .percentile-label {
      font-size: 0.9em;
      color: #666;
      margin-top: 4px;
    }
    .final-score-text {
      font-size: 1.05em;
      font-weight: 700;
      color: #0f3460;
      margin-top: 8px;
    }

    /* --- REPORT SECTION --- */
    .report-section {
      background: #fff;
      border-radius: 12px;
      padding: 24px 28px;
      margin-bottom: 20px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.04);
    }
    .report-section h2 {
      font-size: 1.15em;
      color: #16213e;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f2f5;
    }
    .section-empty {
      color: #888;
      font-style: italic;
      font-size: 0.92em;
    }

    /* --- PLACE ITEMS --- */
    .place-item {
      padding: 12px 0;
      border-bottom: 1px solid #f5f5f5;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .place-item:last-child { border-bottom: none; }
    .place-name { font-weight: 600; color: #1a1a2e; }
    .place-meta { font-size: 0.88em; color: #777; margin-top: 2px; }
    .place-time {
      font-weight: 600;
      font-size: 0.9em;
      color: #0f3460;
      white-space: nowrap;
      padding-left: 16px;
    }

    /* --- STATUS BADGES --- */
    .badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }
    .badge-pass { background: #d1fae5; color: #065f46; }
    .badge-borderline { background: #fff3e0; color: #e65100; }
    .badge-fail { background: #fee2e2; color: #991b1b; }
    .badge-great { background: #d1fae5; color: #065f46; }
    .badge-ok { background: #fff3cd; color: #856404; }
    .badge-painful { background: #fee2e2; color: #991b1b; }

    /* --- CHECK ITEMS --- */
    .check-row {
      display: flex;
      align-items: flex-start;
      padding: 10px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .check-row:last-child { border-bottom: none; }
    .check-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75em;
      font-weight: 700;
      flex-shrink: 0;
      margin-right: 12px;
      margin-top: 1px;
    }
    .check-pass { background: #d1fae5; color: #065f46; }
    .check-fail { background: #fee2e2; color: #991b1b; }
    .check-unknown { background: #fef3c7; color: #92400e; }
    .check-text { flex: 1; }
    .check-label { font-weight: 600; font-size: 0.95em; color: #1a1a2e; }
    .check-detail { font-size: 0.88em; color: #666; }

    /* --- PROXIMITY BAND ITEMS --- */
    .proximity-item {
      padding: 10px 14px;
      border-left: 4px solid #e5e7eb;
      margin-bottom: 8px;
      border-radius: 4px;
      background: #fafafa;
    }
    .proximity-neutral { border-left-color: #86efac; background: #f0fdf4; }
    .proximity-notable { border-left-color: #fbbf24; background: #fffbeb; }
    .proximity-very_close { border-left-color: #f97316; background: #fff7ed; }
    .proximity-name {
      font-weight: 600;
      font-size: 0.95em;
      color: #1a1a2e;
    }
    .proximity-detail {
      font-size: 0.85em;
      color: #555;
      margin-top: 4px;
      line-height: 1.4;
    }

    /* --- SCORE ROWS --- */
    .score-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .score-row:last-child { border-bottom: none; }
    .score-info { flex: 1; }
    .score-name { font-weight: 600; font-size: 0.95em; color: #1a1a2e; }
    .score-detail { font-size: 0.85em; color: #777; margin-top: 2px; }
    .score-pts {
      font-weight: 700;
      font-size: 1em;
      color: #0f3460;
      white-space: nowrap;
      padding-left: 16px;
    }

    /* --- SCORE BAR --- */
    .score-bar-container {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 2px solid #f0f2f5;
    }
    .score-bar-bg {
      width: 100%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 5px;
      overflow: hidden;
    }
    .score-bar-fill {
      height: 100%;
      border-radius: 5px;
      background: #0f3460;
      transition: width 0.6s ease;
    }
    .score-bar-label {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 0.85em;
      color: #888;
    }

    /* --- LEGEND --- */
    .score-legend {
      background: #f8f9fb;
      border-radius: 8px;
      padding: 16px 20px;
      margin-top: 16px;
    }
    .score-legend h3 {
      font-size: 0.88em;
      color: #555;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .legend-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.88em;
      padding: 4px 0;
      color: #555;
    }
    .legend-row .cat { font-weight: 500; }
    .legend-row .pts { color: #0f3460; font-weight: 600; }

    /* --- MISSING INFO --- */
    .missing-section {
      background: #fffbeb;
      border: 1px solid #fde68a;
      border-radius: 10px;
      padding: 20px 24px;
    }
    .missing-section h2 {
      color: #92400e;
      border-bottom-color: #fde68a;
    }
    .missing-item {
      display: flex;
      align-items: flex-start;
      padding: 8px 0;
      gap: 10px;
    }
    .missing-bullet {
      color: #d97706;
      font-weight: 700;
      flex-shrink: 0;
    }
    .missing-text { font-size: 0.92em; color: #78350f; }

    /* --- PARK SUBSCORES --- */
    .subscore-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    .subscore-card {
      background: #f8f9fb;
      border-radius: 6px;
      padding: 8px 12px;
    }
    .subscore-label {
      font-size: 0.78em;
      color: #666;
      text-transform: uppercase;
      font-weight: 600;
    }
    .subscore-label .est { color: #d97706; }
    .subscore-value {
      font-weight: 700;
      color: #16213e;
      font-size: 1em;
    }
    .subscore-reason {
      font-size: 0.78em;
      color: #888;
      margin-top: 2px;
    }

    /* --- HUB ROW --- */
    .hub-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .hub-row:last-child { border-bottom: none; }
    .hub-info { flex: 1; }
    .hub-name { font-weight: 600; font-size: 0.95em; color: #1a1a2e; }
    .hub-detail { font-size: 0.85em; color: #777; margin-top: 2px; }
    .hub-right {
      display: flex;
      align-items: center;
      gap: 10px;
      padding-left: 16px;
    }
    .hub-time { font-weight: 600; color: #0f3460; font-size: 0.95em; white-space: nowrap; }

    /* --- WALK SCORE PILLS --- */
    .walkscore-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid #f0f0f0;
    }
    .walkscore-pill {
      flex: 1;
      min-width: 100px;
      background: #f8f9fb;
      padding: 10px 12px;
      border-radius: 8px;
      text-align: center;
    }
    .walkscore-pill .ws-label {
      font-size: 0.72em;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .walkscore-pill .ws-value {
      font-size: 1.5em;
      font-weight: 700;
      color: #16213e;
    }
    .walkscore-pill .ws-desc {
      font-size: 0.78em;
      color: #666;
    }

    /* --- DISCLAIMER / FOOTER --- */
    .disclaimer {
      max-width: 800px;
      margin: 0 auto 40px;
      padding: 20px 24px;
      font-size: 0.82em;
      color: #999;
      line-height: 1.6;
    }
    .disclaimer strong { color: #777; }

    footer {
      border-top: 1px solid #e0e0e0;
      padding: 24px;
      text-align: center;
      font-size: 0.85em;
      color: #999;
      background: #fff;
    }

    /* --- SHARE BAR --- */
    .share-bar {
      max-width: 800px;
      margin: 0 auto 16px;
      padding: 0 24px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
    }
    .share-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #0f3460;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 0.88em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .share-btn:hover { background: #16213e; }
    .share-btn.copied { background: #065f46; }

    /* --- BUILDER DEBUG --- */
    .builder-debug {
      max-width: 800px;
      margin: 0 auto 16px;
      padding: 12px 20px;
      background: #1a1a2e;
      color: #a5f3a5;
      border-radius: 8px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.78em;
      line-height: 1.5;
    }
    .builder-debug summary {
      cursor: pointer;
      font-weight: 700;
      color: #fbbf24;
    }
    .builder-debug pre {
      margin-top: 8px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    /* --- COLLAPSIBLE SECTIONS --- */
    .collapsible-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }
    .collapsible-toggle h2 { cursor: pointer; flex: 1; }
    .collapse-icon {
      font-size: 0.85em;
      color: #888;
      transition: transform 0.2s;
      flex-shrink: 0;
      margin-left: 8px;
    }
    .collapsible-body {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .collapsible-body.collapsed {
      max-height: 0;
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 640px) {
      .hero h1 { font-size: 2em; }
      .search-box { flex-direction: column; }
      .search-box button { width: 100%; }
      .verdict-card { padding: 24px 20px; }
      .report-section { padding: 20px; }
      .score-circle { width: 100px; height: 100px; }
      .score-circle .number { font-size: 2em; }
      .subscore-grid { grid-template-columns: 1fr 1fr; }
    }

    /* --- PRINT-FRIENDLY / SHARE-READY --- */
    @media print {
      nav, .search-section, .share-bar, .builder-debug, .loading-overlay, footer { display: none; }
      body { background: #fff; }
      .report { margin: 0 auto; }
      .report-section { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; }
      .verdict-card { box-shadow: none; border: 1px solid #ddd; }
    }
  </style>
</head>
<body>

<!-- NAV -->
<nav>
  <a href="/" class="logo">Nest<span>Check</span></a>
  <div>
    {% if is_builder %}
      <a href="/builder/dashboard" class="nav-link" style="color: #fbbf24;">Dashboard</a>
    {% endif %}
  </div>
</nav>

<!-- LOADING OVERLAY -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Evaluating this address...</div>
  <div class="loading-sub">Checking parks, transit, schools, safety, and more. This takes 15-45 seconds.</div>
</div>

{% if not result %}
{# ============================================================ #}
{#                     LANDING PAGE                              #}
{# ============================================================ #}
<div class="hero">
  <h1>Know before you move.</h1>
  <p class="tagline">Evaluate any U.S. address for walkability, green space, transit, schools, and daily-life quality — instant results, shareable link.</p>
</div>

<div class="search-section">
  {% if error %}
    <div class="error-banner">
      <strong>Could not evaluate address</strong>
      {{ error }}
      {% if request_id %}
        <div style="margin-top: 6px; font-size: 0.82em; color: #b91c1c;">ref: {{ request_id }}</div>
      {% endif %}
    </div>
    {% if is_builder and error_detail %}
    <details class="builder-debug" style="max-width: 640px; margin: 0 auto 16px;">
      <summary>Builder diagnostic</summary>
      <pre>{{ error_detail | tojson(indent=2) }}</pre>
    </details>
    {% endif %}
  {% endif %}
  <form method="POST" id="evalForm">
    <div class="search-box">
      <input type="text" name="address" placeholder="Enter any U.S. address..." value="{{ address }}" required>
      <button type="submit" id="evalBtn">Evaluate</button>
    </div>
  </form>
</div>

<div class="features">
  <div class="feature-card">
    <h3>Green Escape</h3>
    <p>Parks, trails, and nature within walking distance. Scored by quality and accessibility.</p>
  </div>
  <div class="feature-card">
    <h3>Urban Access</h3>
    <p>Transit options, commute times, and connectivity to major hubs.</p>
  </div>
  <div class="feature-card">
    <h3>Family &amp; Schools</h3>
    <p>Nearby schools, childcare, and family-friendly infrastructure.</p>
  </div>
  <div class="feature-card">
    <h3>Health &amp; Safety</h3>
    <p>Distance from highways, gas stations, and high-volume roads.</p>
  </div>
  <div class="feature-card">
    <h3>Daily Essentials</h3>
    <p>Walkable groceries, cafes, fitness — the fabric of daily life.</p>
  </div>
  <div class="feature-card">
    <h3>Final Score</h3>
    <p>One number, 0-100. Clear breakdown of how it was computed.</p>
  </div>
</div>

{% else %}
{# ============================================================ #}
{#                        EVALUATION RESULT                      #}
{# ============================================================ #}
<div class="search-section" style="margin-top: 24px;">
  <form method="POST" id="evalForm">
    <div class="search-box">
      <input type="text" name="address" placeholder="Enter any U.S. address..." value="{{ address }}" required>
      <button type="submit" id="evalBtn">New evaluation</button>
    </div>
  </form>
</div>

{% if is_builder and result %}
<!-- BUILDER DEBUG (only visible in builder mode) -->
<details class="builder-debug">
  <summary>Builder Debug{% if snapshot_id %} — Snapshot {{ snapshot_id }}{% endif %}</summary>
  <pre>{% if snapshot_id %}snapshot_id: {{ snapshot_id }}
snapshot_url: /s/{{ snapshot_id }}
{% endif %}address: {{ result.address }}
final_score: {{ result.final_score }}
passed_tier1: {{ result.passed_tier1 }}
coordinates: {{ result.coordinates }}
tier2_raw: {{ result.tier2_score }}/{{ result.tier2_max }}
tier2_normalized: {{ result.tier2_normalized }}
tier3_bonus: {{ result.tier3_bonus }}
walk_scores: {{ result.walk_scores }}
transit_access: {{ result.transit_access }}</pre>
</details>
{% endif %}

{% set is_snapshot = false %}
{% include '_result_sections.html' %}
{% endif %}

<!-- FOOTER -->
<footer>
  NestCheck &middot; Decision support for families optimizing daily life.
</footer>

<script>
  (function() {
    var POLL_INTERVAL_MS = 2000;

    // Stage names from backend -> user-facing progress text
    var STAGE_DISPLAY = {
      geocode: 'Locating address...',
      analyzing: 'Analyzing neighborhood, transit, parks...',
      bike_score: 'Checking bike infrastructure...',
      neighborhood: 'Analyzing nearby amenities...',
      schools: 'Finding schools and childcare...',
      urban_access: 'Calculating commute times...',
      transit_access: 'Evaluating transit options...',
      green_spaces: 'Discovering parks and trails...',
      green_escape: 'Finding your daily green escape...',
      transit_score: 'Getting transit scores...',
      walk_scores: 'Getting walkability scores...',
      tier1_checks: 'Running safety checks...',
      score_park_access: 'Calculating lifestyle scores...',
      score_third_place: 'Calculating lifestyle scores...',
      score_provisioning: 'Calculating lifestyle scores...',
      score_fitness: 'Calculating lifestyle scores...',
      score_transit_access: 'Calculating lifestyle scores...',
      tier3_bonuses: 'Adding bonus points...',
      saving: 'Saving your results...'
    };

    function stageDisplay(stage) {
      return STAGE_DISPLAY[stage] || 'Working...';
    }

    function showError(msg, overlay, btn, form) {
      overlay.classList.remove('active');
      btn.disabled = false;
      btn.textContent = btn.dataset.originalText || 'Evaluate';
      var existingBanner = document.querySelector('.error-banner');
      if (existingBanner) {
        var el = existingBanner.querySelector('.error-msg');
        if (el) el.textContent = msg;
      } else {
        var banner = document.createElement('div');
        banner.className = 'error-banner';
        banner.innerHTML = '<strong>Could not evaluate address</strong><span class="error-msg">' + msg + '</span>';
        form.parentNode.insertBefore(banner, form);
      }
    }

    function startPolling(jobId, overlay, loadingText, loadingSub, btn, form) {
      overlay.classList.add('active');
      loadingText.textContent = 'Evaluating this address...';
      loadingSub.textContent = 'Starting...';

      function poll() {
        fetch('/job/' + jobId, { headers: { 'Accept': 'application/json' } })
          .then(function(r) {
            if (!r.ok) {
              if (r.status === 404) showError('Job not found.', overlay, btn, form);
              return null;
            }
            return r.json();
          })
          .then(function(data) {
            if (!data) return;
            if (data.current_stage) {
              loadingSub.textContent = stageDisplay(data.current_stage);
            }
            if (data.status === 'done' && data.snapshot_id) {
              window.location.href = '/s/' + data.snapshot_id;
              return;
            }
            if (data.status === 'failed') {
              showError(data.error || 'Evaluation failed.', overlay, btn, form);
              return;
            }
            setTimeout(poll, POLL_INTERVAL_MS);
          })
          .catch(function(err) {
            showError('Could not check job status. Please try again. (' + err.message + ')', overlay, btn, form);
          });
      }
      poll();
    }

    document.getElementById('evalForm').addEventListener('submit', function(e) {
      e.preventDefault();
      var form = e.target;
      var btn = document.getElementById('evalBtn');
      var overlay = document.getElementById('loadingOverlay');
      var loadingText = overlay.querySelector('.loading-text');
      var loadingSub = overlay.querySelector('.loading-sub');
      var address = form.querySelector('input[name="address"]').value.trim();
      if (!address) return;

      btn.disabled = true;
      btn.textContent = 'Evaluating...';
      overlay.classList.add('active');
      loadingText.textContent = 'Evaluating this address...';
      loadingSub.textContent = 'Submitting...';

      var body = new FormData(form);
      fetch('/', {
        method: 'POST',
        body: body,
        headers: { 'Accept': 'application/json' }
      })
        .then(function(resp) { return resp.json(); })
        .then(function(data) {
          if (data.error) {
            var traceRef = data.request_id ? ' (ref: ' + data.request_id + ')' : '';
            showError(data.error + traceRef, overlay, btn, form);
          } else if (data.job_id) {
            startPolling(data.job_id, overlay, loadingText, loadingSub, btn, form);
          } else {
            showError('Unexpected response from server.', overlay, btn, form);
          }
        })
        .catch(function(err) {
          showError('Network error. Please try again. (' + err.message + ')', overlay, btn, form);
        });
    });

    var evalBtn = document.getElementById('evalBtn');
    if (evalBtn) evalBtn.dataset.originalText = evalBtn.textContent;

    // If we landed with ?job_id= (e.g. non-JS form POST redirect), start polling
    var initialJobId = '{{ job_id or "" }}';
    if (initialJobId) {
      var overlay = document.getElementById('loadingOverlay');
      var loadingText = overlay && overlay.querySelector('.loading-text');
      var loadingSub = overlay && overlay.querySelector('.loading-sub');
      if (overlay && loadingText && loadingSub) {
        var form = document.getElementById('evalForm');
        var btn = document.getElementById('evalBtn');
        if (btn) btn.disabled = true;
        startPolling(initialJobId, overlay, loadingText, loadingSub, btn || {}, form || document.body);
      }
    }
  })();

  function copyShareLink() {
    var snapshotId = '{{ snapshot_id or "" }}';
    if (!snapshotId) return;
    var url = window.location.origin + '/s/' + snapshotId;
    navigator.clipboard.writeText(url).then(function() {
      var btn = document.getElementById('shareBtn');
      var txt = document.getElementById('shareBtnText');
      btn.classList.add('copied');
      txt.textContent = 'Copied!';
      setTimeout(function() {
        btn.classList.remove('copied');
        txt.textContent = 'Copy share link';
      }, 2000);

      // Track share event
      fetch('/api/event', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          event_type: 'snapshot_shared',
          snapshot_id: snapshotId
        })
      }).catch(function() {});
    });
  }

  function toggleSection(el) {
    var body = el.nextElementSibling;
    var icon = el.querySelector('.collapse-icon');
    if (body.classList.contains('collapsed')) {
      body.classList.remove('collapsed');
      icon.innerHTML = '&#9660;';
    } else {
      body.classList.add('collapsed');
      icon.innerHTML = '&#9654;';
    }
  }
</script>

</body>
</html>
