<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NestCheck — Know Before You Move</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #1a1a2e;
      background: #f0f2f5;
    }

    /* --- NAV --- */
    nav {
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      padding: 14px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav .logo {
      font-size: 1.35em;
      font-weight: 700;
      color: #16213e;
      text-decoration: none;
    }
    nav .logo span { color: #0f3460; }
    nav a.nav-link {
      color: #555;
      text-decoration: none;
      font-size: 0.95em;
      font-weight: 500;
      margin-left: 20px;
    }
    nav a.nav-link:hover { color: #0f3460; }

    /* --- HERO / LANDING --- */
    .hero {
      max-width: 700px;
      margin: 60px auto 0;
      text-align: center;
      padding: 0 24px;
    }
    .hero h1 {
      font-size: 2.6em;
      font-weight: 800;
      color: #16213e;
      margin-bottom: 12px;
      letter-spacing: -0.02em;
    }
    .hero .tagline {
      font-size: 1.15em;
      color: #555;
      margin-bottom: 36px;
      max-width: 520px;
      margin-left: auto;
      margin-right: auto;
    }

    /* --- FORM --- */
    .search-section {
      max-width: 640px;
      margin: 0 auto 30px;
      padding: 0 24px;
    }
    .search-box {
      display: flex;
      gap: 10px;
      background: #fff;
      padding: 8px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 2px solid #e8e8e8;
      transition: border-color 0.2s;
    }
    .search-box:focus-within {
      border-color: #0f3460;
    }
    .search-box input[type="text"] {
      flex: 1;
      padding: 14px 16px;
      border: none;
      font-size: 16px;
      background: transparent;
      outline: none;
      color: #1a1a2e;
    }
    .search-box input[type="text"]::placeholder { color: #999; }
    .search-box button {
      padding: 14px 28px;
      background: #0f3460;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .search-box button:hover { background: #16213e; }
    .search-box button:disabled {
      background: #8899aa;
      cursor: not-allowed;
    }

    /* --- FEATURES (landing) --- */
    .features {
      max-width: 700px;
      margin: 40px auto 60px;
      padding: 0 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }
    .feature-card {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #eee;
    }
    .feature-card h3 {
      font-size: 0.95em;
      color: #16213e;
      margin-bottom: 6px;
    }
    .feature-card p {
      font-size: 0.88em;
      color: #666;
      line-height: 1.5;
    }

    /* --- LOADING --- */
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.92);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .loading-overlay.active { display: flex; }
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e0e0e0;
      border-top-color: #0f3460;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      margin-top: 20px;
      font-size: 1.05em;
      color: #333;
      font-weight: 500;
    }
    .loading-sub {
      margin-top: 8px;
      font-size: 0.88em;
      color: #888;
    }

    /* --- ERROR --- */
    .error-banner {
      max-width: 640px;
      margin: 0 auto 20px;
      padding: 16px 20px;
      background: #fef2f2;
      border: 1px solid #fca5a5;
      border-radius: 10px;
      color: #991b1b;
      font-size: 0.95em;
    }
    .error-banner strong { display: block; margin-bottom: 4px; }

    /* --- REPORT CONTAINER --- */
    .report {
      max-width: 800px;
      margin: 30px auto 60px;
      padding: 0 24px;
    }

    /* --- VERDICT HEADER --- */
    .verdict-card {
      background: #fff;
      border-radius: 14px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      text-align: center;
    }
    .verdict-address {
      font-size: 0.9em;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 12px;
    }
    .verdict-text {
      font-size: 1.4em;
      font-weight: 700;
      color: #16213e;
      margin-bottom: 20px;
    }
    .score-circle {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0f3460, #16213e);
      color: #fff;
      margin-bottom: 12px;
    }
    .score-circle .number {
      font-size: 2.4em;
      font-weight: 800;
      line-height: 1;
    }
    .score-circle .label {
      font-size: 0.72em;
      opacity: 0.8;
      margin-top: 2px;
    }
    .score-failed .score-circle {
      background: linear-gradient(135deg, #7f1d1d, #991b1b);
    }
    .percentile-label {
      font-size: 0.9em;
      color: #666;
      margin-top: 4px;
    }

    /* --- REPORT SECTION --- */
    .report-section {
      background: #fff;
      border-radius: 12px;
      padding: 24px 28px;
      margin-bottom: 20px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.04);
    }
    .report-section h2 {
      font-size: 1.15em;
      color: #16213e;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f2f5;
    }

    /* --- PLACE ITEMS --- */
    .place-item {
      padding: 12px 0;
      border-bottom: 1px solid #f5f5f5;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .place-item:last-child { border-bottom: none; }
    .place-name { font-weight: 600; color: #1a1a2e; }
    .place-meta { font-size: 0.88em; color: #777; margin-top: 2px; }
    .place-time {
      font-weight: 600;
      font-size: 0.9em;
      color: #0f3460;
      white-space: nowrap;
      padding-left: 16px;
    }

    /* --- CHECK ITEMS --- */
    .check-row {
      display: flex;
      align-items: flex-start;
      padding: 10px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .check-row:last-child { border-bottom: none; }
    .check-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75em;
      font-weight: 700;
      flex-shrink: 0;
      margin-right: 12px;
      margin-top: 1px;
    }
    .check-pass { background: #d1fae5; color: #065f46; }
    .check-fail { background: #fee2e2; color: #991b1b; }
    .check-unknown { background: #fef3c7; color: #92400e; }
    .check-text { flex: 1; }
    .check-label { font-weight: 600; font-size: 0.95em; color: #1a1a2e; }
    .check-detail { font-size: 0.88em; color: #666; }

    /* --- SCORE ROWS --- */
    .score-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .score-row:last-child { border-bottom: none; }
    .score-info { flex: 1; }
    .score-name { font-weight: 600; font-size: 0.95em; color: #1a1a2e; }
    .score-detail { font-size: 0.85em; color: #777; margin-top: 2px; }
    .score-pts {
      font-weight: 700;
      font-size: 1em;
      color: #0f3460;
      white-space: nowrap;
      padding-left: 16px;
    }

    /* --- SCORE BAR --- */
    .score-bar-container {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 2px solid #f0f2f5;
    }
    .score-bar-bg {
      width: 100%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 5px;
      overflow: hidden;
    }
    .score-bar-fill {
      height: 100%;
      border-radius: 5px;
      background: #0f3460;
      transition: width 0.6s ease;
    }
    .score-bar-label {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 0.85em;
      color: #888;
    }

    /* --- LEGEND --- */
    .score-legend {
      background: #f8f9fb;
      border-radius: 8px;
      padding: 16px 20px;
      margin-top: 16px;
    }
    .score-legend h3 {
      font-size: 0.88em;
      color: #555;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .legend-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.88em;
      padding: 4px 0;
      color: #555;
    }
    .legend-row .cat { font-weight: 500; }
    .legend-row .pts { color: #0f3460; font-weight: 600; }

    /* --- MISSING INFO --- */
    .missing-section {
      background: #fffbeb;
      border: 1px solid #fde68a;
      border-radius: 10px;
      padding: 20px 24px;
    }
    .missing-section h2 {
      color: #92400e;
      border-bottom-color: #fde68a;
    }
    .missing-item {
      display: flex;
      align-items: flex-start;
      padding: 8px 0;
      gap: 10px;
    }
    .missing-bullet {
      color: #d97706;
      font-weight: 700;
      flex-shrink: 0;
    }
    .missing-text { font-size: 0.92em; color: #78350f; }

    /* --- DISCLAIMER / FOOTER --- */
    .disclaimer {
      max-width: 800px;
      margin: 0 auto 40px;
      padding: 20px 24px;
      font-size: 0.82em;
      color: #999;
      line-height: 1.6;
    }
    .disclaimer strong { color: #777; }

    footer {
      border-top: 1px solid #e0e0e0;
      padding: 24px;
      text-align: center;
      font-size: 0.85em;
      color: #999;
      background: #fff;
    }

    /* --- CTA BANNER --- */
    .cta-banner {
      background: linear-gradient(135deg, #0f3460, #16213e);
      color: #fff;
      border-radius: 12px;
      padding: 28px 32px;
      margin-bottom: 24px;
      text-align: center;
    }
    .cta-banner h3 {
      font-size: 1.15em;
      margin-bottom: 8px;
    }
    .cta-banner p {
      font-size: 0.92em;
      opacity: 0.85;
      margin-bottom: 16px;
    }
    .cta-btn {
      display: inline-block;
      padding: 12px 28px;
      background: #fff;
      color: #0f3460;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.95em;
      text-decoration: none;
      transition: opacity 0.2s;
    }
    .cta-btn:hover { opacity: 0.9; }

    /* --- RESPONSIVE --- */
    @media (max-width: 640px) {
      .hero h1 { font-size: 2em; }
      .search-box { flex-direction: column; }
      .search-box button { width: 100%; }
      .verdict-card { padding: 24px 20px; }
      .report-section { padding: 20px; }
      .score-circle { width: 100px; height: 100px; }
      .score-circle .number { font-size: 2em; }
    }
  </style>
</head>
<body>

<!-- NAV -->
<nav>
  <a href="/" class="logo">Nest<span>Check</span></a>
  <div>
    <a href="/pricing" class="nav-link">Pricing</a>
  </div>
</nav>

<!-- LOADING OVERLAY -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Evaluating this address...</div>
  <div class="loading-sub">Checking parks, transit, schools, safety, and more. This takes 15-45 seconds.</div>
</div>

{% if not result %}
<!-- ============================================================ -->
<!--                     LANDING PAGE                              -->
<!-- ============================================================ -->
<div class="hero">
  <h1>Know before you move.</h1>
  <p class="tagline">Evaluate any U.S. address for walkability, green space, transit, schools, and daily-life quality — in one report.</p>
</div>

<div class="search-section">
  {% if error %}
    <div class="error-banner">
      <strong>Could not generate report</strong>
      {{ error }}
    </div>
  {% endif %}
  <form method="POST" id="evalForm">
    <div class="search-box">
      <input type="text" name="address" placeholder="Enter any U.S. address..." value="{{ address }}" required>
      <button type="submit" id="evalBtn">Generate Report</button>
    </div>
  </form>
</div>

<div class="features">
  <div class="feature-card">
    <h3>Green Escape</h3>
    <p>Parks, trails, and nature within walking distance. Scored by quality and accessibility.</p>
  </div>
  <div class="feature-card">
    <h3>Urban Access</h3>
    <p>Transit options, commute times, and connectivity to major hubs.</p>
  </div>
  <div class="feature-card">
    <h3>Family &amp; Schools</h3>
    <p>Nearby schools, childcare, and family-friendly infrastructure.</p>
  </div>
  <div class="feature-card">
    <h3>Health &amp; Safety</h3>
    <p>Distance from highways, gas stations, and high-volume roads.</p>
  </div>
  <div class="feature-card">
    <h3>Daily Essentials</h3>
    <p>Walkable groceries, cafes, fitness — the fabric of daily life.</p>
  </div>
  <div class="feature-card">
    <h3>Final Score</h3>
    <p>One number, 0-100. Clear breakdown of how it was computed.</p>
  </div>
</div>

{% else %}
<!-- ============================================================ -->
<!--                        REPORT                                 -->
<!-- ============================================================ -->
<div class="search-section" style="margin-top: 24px;">
  <form method="POST" id="evalForm">
    <div class="search-box">
      <input type="text" name="address" placeholder="Enter any U.S. address..." value="{{ address }}" required>
      <button type="submit" id="evalBtn">New Report</button>
    </div>
  </form>
</div>

<div class="report">

  <!-- VERDICT + SCORE -->
  <div class="verdict-card{% if not result.passed_tier1 %} score-failed{% endif %}">
    <div class="verdict-address">{{ result.address }}</div>
    <div class="score-circle">
      <div class="number">{{ result.final_score }}</div>
      <div class="label">/ 100</div>
    </div>
    <div class="verdict-text">{{ result.verdict }}</div>
    {% if result.passed_tier1 and result.percentile_label %}
      <div class="percentile-label">{{ result.percentile_label }}</div>
    {% endif %}
  </div>

  {% if result.passed_tier1 %}

  <!-- 1. GREEN ESCAPE -->
  {% if result.green_space_evaluation %}
  <div class="report-section">
    <h2>Green Escape</h2>
    {% if result.green_space_evaluation.green_escape %}
      <div class="place-item">
        <div>
          <div class="place-name">{{ result.green_space_evaluation.green_escape.name }}</div>
          <div class="place-meta">
            {% if result.green_space_evaluation.green_escape.rating %}
              {{ "%.1f"|format(result.green_space_evaluation.green_escape.rating) }} stars
              {% if result.green_space_evaluation.green_escape.user_ratings_total %}
                ({{ result.green_space_evaluation.green_escape.user_ratings_total }} reviews)
              {% endif %}
            {% endif %}
            {% if result.green_space_evaluation.green_escape.types_display %}
              &middot; {{ result.green_space_evaluation.green_escape.types_display }}
            {% endif %}
          </div>
        </div>
        <div class="place-time">{{ result.green_space_evaluation.green_escape.walk_time_min }} min walk</div>
      </div>
    {% else %}
      <p style="color: #888; font-style: italic;">{{ result.green_space_evaluation.green_escape_message or "No major green escape found within walkable radius." }}</p>
    {% endif %}

    {% if result.green_space_evaluation.other_green_spaces %}
      <div style="margin-top: 14px; padding-top: 14px; border-top: 1px solid #f0f0f0;">
        <div style="font-size: 0.85em; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.03em;">Other nearby green spaces</div>
        {% for space in result.green_space_evaluation.other_green_spaces[:4] %}
          <div class="place-item">
            <div>
              <div class="place-name" style="font-weight: 500;">{{ space.name }}</div>
              <div class="place-meta">
                {% if space.rating %}{{ "%.1f"|format(space.rating) }} stars{% endif %}
                {% if space.user_ratings_total %}({{ space.user_ratings_total }} reviews){% endif %}
              </div>
            </div>
            <div class="place-time">{{ space.walk_time_min }} min walk</div>
          </div>
        </div>
      {% endif %}

      <!-- TIER 0: URBAN ACCESS -->
      {% if result.urban_access or result.transit_access %}
        <div class="tier-section">
          <h2>Urban Access Engine</h2>
          <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">

            <!-- Smart Transit Frequency -->
            {% if result.transit_access %}
              <div style="margin-bottom: 18px;">
                <strong style="color: #ef6c00;">Transit Frequency (Smart Approximation)</strong>
                {% if result.transit_access.primary_stop %}
                  <div style="margin-top: 10px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #ffe0b2;">
                    <div style="font-weight: 600; color: #2c3e50; font-size: 1.05em;">
                      Primary Transit: {{ result.transit_access.primary_stop }}
                      — {{ result.transit_access.walk_minutes }} min walk
                      | Mode: {{ result.transit_access.mode }}
                      | Service: {{ result.transit_access.frequency_bucket }} frequency
                      | Urban Access Score: {{ result.transit_access.score_0_10 }}/10
                    </div>
                  </div>
                  <details style="margin-top: 10px; cursor: pointer;">
                    <summary style="font-weight: 600; color: #e65100; padding: 6px 0; user-select: none;">Why?</summary>
                    <ul style="list-style: none; padding-left: 0; margin-top: 8px;">
                      {% for reason in result.transit_access.reasons %}
                        <li style="margin-bottom: 6px; padding: 6px 10px; background: #fff8e1; border-radius: 4px; font-size: 0.93em; color: #5d4037;">
                          {{ reason }}
                        </li>
                      {% endfor %}
                    </ul>
                  </details>
                {% else %}
                  <div style="color: #7f8c8d; font-style: italic; margin-top: 8px;">
                    No transit stations found nearby (score 0/10)
                  </div>
                  {% if result.transit_access.reasons %}
                    <details style="margin-top: 6px; cursor: pointer;">
                      <summary style="font-weight: 600; color: #e65100; padding: 6px 0; user-select: none;">Why?</summary>
                      <ul style="list-style: none; padding-left: 0; margin-top: 8px;">
                        {% for reason in result.transit_access.reasons %}
                          <li style="margin-bottom: 6px; padding: 6px 10px; background: #fff8e1; border-radius: 4px; font-size: 0.93em; color: #5d4037;">
                            {{ reason }}
                          </li>
                        {% endfor %}
                      </ul>
                    </details>
                  {% endif %}
                {% endif %}
              </div>
            {% endif %}

            <div style="margin-bottom: 18px;">
              <strong style="color: #ef6c00;">Transit Score</strong>
              {% if result.transit_score and result.transit_score.transit_score is not none %}
                <div style="margin-top: 8px;">
                  Transit Score: {{ result.transit_score.transit_score }}
                  {% if result.transit_score.transit_rating %}
                    — {{ result.transit_score.transit_rating }}
                  {% endif %}
                </div>
                {% if result.transit_score.transit_summary %}
                  <div style="color: #666; margin-top: 4px;">
                    {{ result.transit_score.transit_summary }}
                  </div>
                {% endif %}
                {% if result.transit_score.nearby_transit_lines %}
                  <ul style="list-style: none; margin-top: 10px; padding-left: 0;">
                    {% for line in result.transit_score.nearby_transit_lines[:5] %}
                      <li style="margin-bottom: 6px;">
                        - {{ line.name }}
                        {% if line.type %}<span style="color: #666;">({{ line.type }})</span>{% endif %}
                        {% if line.distance_miles is not none %}
                          — {{ "%.1f"|format(line.distance_miles) }} mi
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                {% endif %}
              {% else %}
                <div style="color: #7f8c8d; font-style: italic; margin-top: 8px;">Transit data not available</div>
              {% endif %}
            </div>
            {% if result.urban_access %}
            <div style="margin-bottom: 18px;">
              <strong style="color: #ef6c00;">Primary Transit Node</strong>
              {% if result.urban_access.primary_transit %}
                {% set pt = result.urban_access.primary_transit %}
                <div style="margin-top: 8px;">
                  {{ pt.name }} ({{ pt.mode }})
                  — {{ pt.walk_time_min }} min walk
                </div>
                {% if pt.drive_time_min %}
                  <div style="color: #666; margin-top: 6px;">
                    Drive to station — {{ pt.drive_time_min }} min
                  </div>
                {% endif %}
                {% if pt.frequency_class %}
                  <div style="color: #666; margin-top: 4px;">
                    Frequency — {{ pt.frequency_class }}
                  </div>
                {% endif %}
                {% if pt.parking_available %}
                  <div style="color: #666; margin-top: 4px;">
                    Parking — available
                  </div>
                {% endif %}
              {% else %}
                <div style="color: #7f8c8d; font-style: italic; margin-top: 8px;">No nearby transit stops found</div>
              {% endif %}
            </div>

            {# --- 2. Commute to Primary Hub --- #}
            <div style="margin-bottom: 18px;">
              <strong style="color: #ef6c00;">Commute to Primary Hub</strong>
              {% if result.urban_access.primary_hub_commute %}
                {% set phc = result.urban_access.primary_hub_commute %}
                <div style="margin-top: 8px; padding: 10px; background: white; border-radius: 4px;">
                  <strong>{{ phc.hub_name }}</strong>
                  — {{ phc.time_min }} min via {{ phc.mode }}
                  {% if phc.fallback %}
                    <span style="color: #e67e22; font-size: 0.85em;">(transit unavailable, driving estimate)</span>
                  {% endif %}
                  <span style="display: inline-block; margin-left: 8px; padding: 2px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600;
                    {% if phc.verdict == 'Great' %}
                      background: #d4edda; color: #155724;
                    {% elif phc.verdict == 'OK' %}
                      background: #fff3cd; color: #856404;
                    {% else %}
                      background: #f8d7da; color: #721c24;
                    {% endif %}
                  ">{{ phc.verdict }}</span>
                </div>
              {% else %}
                <div style="color: #7f8c8d; font-style: italic; margin-top: 8px;">
                  Primary hub commute data unavailable
                </div>
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>
      {% endif %}

      <!-- GREEN ESCAPE (Daily Outdoor Life) — New Engine -->
      {% if result.green_escape %}
        <div class="tier-section">
          <h2>Green Escape (Daily Outdoor Life)</h2>
          <div style="background: #f1f8f4; padding: 20px; border-radius: 8px; border-left: 4px solid #2e7d32;">

            <!-- Best Daily Park Card -->
            {% if result.green_escape.best_daily_park %}
              {% set park = result.green_escape.best_daily_park %}
              <div style="background: white; border-radius: 8px; padding: 18px; margin-bottom: 18px; border: 1px solid #c8e6c9;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
                  <div>
                    <div style="font-size: 1.15em; font-weight: 700; color: #1b5e20;">
                      Best Daily Park: {{ park.name }}
                    </div>
                    <div style="color: #555; margin-top: 4px;">
                      {% if park.rating %}{{ "%.1f"|format(park.rating) }}★{% endif %}
                      {% if park.user_ratings_total %} · {{ park.user_ratings_total }} reviews{% endif %}
                      · {{ park.walk_time_min }} min walk
                      <span style="color: #999; font-size: 0.9em;">({{ park.types_display }})</span>
                    </div>
                  </div>
                  <div style="text-align: center; min-width: 80px;">
                    <div style="font-size: 2em; font-weight: 700; color: {% if park.daily_walk_value >= 7 %}#2e7d32{% elif park.daily_walk_value >= 5 %}#f57f17{% else %}#c62828{% endif %};">
                      {{ "%.1f"|format(park.daily_walk_value) }}
                    </div>
                    <div style="font-size: 0.75em; color: #666; text-transform: uppercase;">Daily Value /10</div>
                  </div>
                </div>

                <!-- Criteria Status Badge -->
                <div style="margin-top: 12px;">
                  {% if park.criteria_status == "PASS" %}
                    <span style="display: inline-block; background: #c8e6c9; color: #1b5e20; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">PASS</span>
                  {% elif park.criteria_status == "BORDERLINE" %}
                    <span style="display: inline-block; background: #fff3e0; color: #e65100; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">BORDERLINE</span>
                  {% else %}
                    <span style="display: inline-block; background: #ffebee; color: #c62828; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">FAIL</span>
                  {% endif %}
                  {% for reason in park.criteria_reasons %}
                    <span style="color: #666; font-size: 0.85em; margin-left: 6px;">{{ reason }}</span>
                  {% endfor %}
                </div>

                <!-- Subscores -->
                <div style="margin-top: 14px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                  {% for ss in park.subscores %}
                    <div style="background: #f9fbe7; border-radius: 6px; padding: 8px 12px;">
                      <div style="font-size: 0.8em; color: #558b2f; text-transform: uppercase; font-weight: 600;">
                        {{ ss.name }}
                        {% if ss.is_estimate %}<span style="color: #ff8f00;">(est)</span>{% endif %}
                      </div>
                      <div style="font-weight: 700; color: #33691e; font-size: 1.1em;">
                        {{ "%.1f"|format(ss.score) }} / {{ "%.0f"|format(ss.max_score) }}
                      </div>
                      <div style="font-size: 0.8em; color: #666; margin-top: 2px;">{{ ss.reason }}</div>
                    </div>
                  {% endfor %}
                </div>

                <!-- Why This Park -->
                {% if park.reasons %}
                  <div style="margin-top: 14px; padding: 10px 14px; background: #e8f5e9; border-radius: 6px;">
                    <div style="font-weight: 600; color: #2e7d32; font-size: 0.9em; margin-bottom: 6px;">Why this park?</div>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                      {% for reason in park.reasons %}
                        <li style="color: #444; font-size: 0.9em; margin-bottom: 3px;">+ {{ reason }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}

                <!-- OSM enrichment note -->
                {% if park.osm_enriched %}
                  <div style="margin-top: 8px; font-size: 0.8em; color: #888;">
                    OpenStreetMap data: {% if park.osm_area_sqm %}~{{ "%.0f"|format(park.osm_area_sqm / 4047) }} acres{% endif %}
                    {% if park.osm_path_count %} · {{ park.osm_path_count }} paths{% endif %}
                    {% if park.osm_has_trail %} · trail detected{% endif %}
                    {% if park.osm_nature_tags %} · {{ park.osm_nature_tags | join(", ") }}{% endif %}
                  </div>
                {% elif park.subscores | selectattr("is_estimate") | list %}
                  <div style="margin-top: 8px; font-size: 0.8em; color: #ff8f00;">
                    Size/loop data estimated from reviews and name (no OSM polygon available).
                  </div>
                {% endif %}
              </div>
            {% else %}
              <div style="color: #7f8c8d; font-style: italic; margin-bottom: 16px;">
                No green spaces found within walking distance.
                {% for msg in result.green_escape.messages %}
                  <br>{{ msg }}
                {% endfor %}
              </div>
            {% endif %}

            <!-- Nearby Green Spaces List -->
            <div style="margin-top: 4px;">
              <strong style="color: #1b5e20;">Other Nearby Green Spaces</strong>
              {% if result.green_escape.nearby_green_spaces %}
                <div style="margin-top: 10px;">
                  {% for space in result.green_escape.nearby_green_spaces %}
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; margin-bottom: 6px; background: white; border-radius: 6px; border-left: 3px solid {% if space.criteria_status == 'PASS' %}#4caf50{% elif space.criteria_status == 'BORDERLINE' %}#ff9800{% else %}#ef5350{% endif %};">
                      <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; color: #333;">
                          {{ space.name }}
                          {% if space.criteria_status == "PASS" %}
                            <span style="font-size: 0.75em; background: #c8e6c9; color: #1b5e20; padding: 2px 8px; border-radius: 8px; margin-left: 6px;">PASS</span>
                          {% elif space.criteria_status == "BORDERLINE" %}
                            <span style="font-size: 0.75em; background: #fff3e0; color: #e65100; padding: 2px 8px; border-radius: 8px; margin-left: 6px;">BORDERLINE</span>
                          {% else %}
                            <span style="font-size: 0.75em; background: #ffebee; color: #c62828; padding: 2px 8px; border-radius: 8px; margin-left: 6px;">FAIL</span>
                          {% endif %}
                        </div>
                        <div style="color: #666; font-size: 0.85em; margin-top: 2px;">
                          {% if space.rating %}{{ "%.1f"|format(space.rating) }}★{% endif %}
                          {% if space.user_ratings_total %} · {{ space.user_ratings_total }} reviews{% endif %}
                          · {{ space.walk_time_min }} min walk
                          · Score: {{ "%.1f"|format(space.daily_walk_value) }}/10
                        </div>
                        {% if space.criteria_reasons %}
                          <div style="color: #888; font-size: 0.8em; margin-top: 2px;">{{ space.criteria_reasons[0] }}</div>
                        {% endif %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div style="color: #7f8c8d; font-style: italic; margin-top: 8px;">
                  No other green spaces found within walking distance.
                </div>
              {% endif %}
            </div>

            <!-- Engine messages -->
            {% if result.green_escape.messages %}
              <div style="margin-top: 14px; padding: 10px; background: #fff8e1; border-radius: 6px; font-size: 0.85em; color: #8d6e00;">
                {% for msg in result.green_escape.messages %}
                  <div>{{ msg }}</div>
                {% endfor %}
              </div>
            {% endif %}

            <!-- Criteria reference -->
            {% if result.green_escape.criteria %}
              <details style="margin-top: 12px; font-size: 0.8em; color: #888;">
                <summary style="cursor: pointer; color: #666;">Scoring criteria</summary>
                <div style="margin-top: 6px; padding: 8px; background: #fafafa; border-radius: 4px;">
                  <div>Walk time max: {{ result.green_escape.criteria.walk_time_max_min }} min</div>
                  <div>Walk time ideal: {{ result.green_escape.criteria.walk_time_ideal_min }} min</div>
                  <div>Pass threshold: {{ result.green_escape.criteria.daily_value_pass_threshold }}/10</div>
                  <div>Model: {{ result.green_escape.criteria.scoring_model }}</div>
                </div>
              </details>
            {% endif %}
          </div>
        </div>

      <!-- Fallback: legacy green space evaluation -->
      {% elif result.green_space_evaluation %}
        <div class="tier-section">
          <h2>Primary Green Escape</h2>
          <div style="background: #f1f8f4; padding: 20px; border-radius: 8px; border-left: 4px solid #2e7d32;">
            {% if result.green_space_evaluation.green_escape %}
              <div style="margin-bottom: 16px;">
                <strong style="color: #1b5e20;">{{ result.green_space_evaluation.green_escape.name }}</strong>
                {% if result.green_space_evaluation.green_escape.rating %}
                  ({{ "%.1f"|format(result.green_space_evaluation.green_escape.rating) }}★,
                  {{ result.green_space_evaluation.green_escape.user_ratings_total }} reviews)
                {% endif %}
                — {{ result.green_space_evaluation.green_escape.walk_time_min }} min walk
              </div>
            {% else %}
              {{ result.urban_access.major_hub.travel_time_min }} min {{ result.urban_access.major_hub.transit_mode }}
            {% endif %}
            {% if result.green_space_evaluation.other_green_spaces %}
              <div style="margin-top: 18px;">
                <strong style="color: #1b5e20;">Other Nearby Green Spaces</strong>
                <ul style="list-style: none; margin-top: 10px; padding-left: 0;">
                  {% for space in result.green_space_evaluation.other_green_spaces %}
                    <li style="margin-bottom: 10px;">
                      {{ space.name }}
                      {% if space.rating %}({{ "%.1f"|format(space.rating) }}★){% endif %}
                      — {{ space.walk_time_min }} min walk
                    </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          </div>
        </div>
        <div class="place-time">{{ result.urban_access.major_hub.travel_time_min }} min</div>
      </div>
    {% endif %}

    {% if result.walk_scores %}
      <div style="margin-top: 14px; padding-top: 14px; border-top: 1px solid #f0f0f0; display: flex; gap: 16px; flex-wrap: wrap;">
        {% if result.walk_scores.walk_score is not none %}
          <div style="flex: 1; min-width: 120px; background: #f8f9fb; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.75em; color: #888; text-transform: uppercase;">Walk Score</div>
            <div style="font-size: 1.6em; font-weight: 700; color: #16213e;">{{ result.walk_scores.walk_score }}</div>
            {% if result.walk_scores.walk_description %}
              <div style="font-size: 0.8em; color: #666;">{{ result.walk_scores.walk_description }}</div>
            {% endif %}
          </div>
        {% endif %}
        {% if result.walk_scores.transit_score is not none %}
          <div style="flex: 1; min-width: 120px; background: #f8f9fb; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.75em; color: #888; text-transform: uppercase;">Transit Score</div>
            <div style="font-size: 1.6em; font-weight: 700; color: #16213e;">{{ result.walk_scores.transit_score }}</div>
            {% if result.walk_scores.transit_description %}
              <div style="font-size: 0.8em; color: #666;">{{ result.walk_scores.transit_description }}</div>
            {% endif %}
          </div>
        {% endif %}
        {% if result.walk_scores.bike_score is not none %}
          <div style="flex: 1; min-width: 120px; background: #f8f9fb; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.75em; color: #888; text-transform: uppercase;">Bike Score</div>
            <div style="font-size: 1.6em; font-weight: 700; color: #16213e;">{{ result.walk_scores.bike_score }}</div>
            {% if result.walk_scores.bike_description %}
              <div style="font-size: 0.8em; color: #666;">{{ result.walk_scores.bike_description }}</div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <!-- 3. FAMILY & SCHOOLING -->
  {% if result.child_schooling_snapshot %}
  <div class="report-section">
    <h2>Family &amp; Schooling</h2>

    {% if result.child_schooling_snapshot.childcare %}
      <div style="font-size: 0.85em; color: #888; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 8px;">Childcare (ages 0-5)</div>
      {% for place in result.child_schooling_snapshot.childcare[:3] %}
        <div class="place-item">
          <div>
            <div class="place-name" style="font-weight: 500;">{{ place.name }}</div>
            <div class="place-meta">
              {% if place.rating %}{{ "%.1f"|format(place.rating) }} stars{% endif %}
              {% if place.user_ratings_total %}({{ place.user_ratings_total }} reviews){% endif %}
              {% if place.website %}&middot; <a href="{{ place.website }}" target="_blank" rel="noopener" style="color: #0f3460;">Website</a>{% endif %}
            </div>
          </div>
          <div class="place-time">{{ place.walk_time_min }} min walk</div>
        </div>
      {% endfor %}
    {% else %}
      <p style="color: #888; font-style: italic; margin-bottom: 12px;">No nearby childcare options found.</p>
    {% endif %}

    {% if result.child_schooling_snapshot.schools_by_level %}
      <div style="font-size: 0.85em; color: #888; text-transform: uppercase; letter-spacing: 0.03em; margin-top: 16px; margin-bottom: 8px;">Schools (ages 5-18)</div>
      {% for level in ["Elementary", "Middle", "High"] %}
        {% set place = result.child_schooling_snapshot.schools_by_level.get(level) %}
        <div class="place-item">
          <div>
            <div class="place-name" style="font-weight: 500;">
              {{ level }}:
              {% if place %}
                {{ place.name }}
              {% else %}
                <span style="color: #999; font-weight: 400; font-style: italic;">Not found nearby</span>
              {% endif %}
            </div>
            {% if place %}
              <div class="place-meta">
                {% if place.rating %}{{ "%.1f"|format(place.rating) }} stars{% endif %}
                {% if place.user_ratings_total %}({{ place.user_ratings_total }} reviews){% endif %}
                {% if place.website %}&middot; <a href="{{ place.website }}" target="_blank" rel="noopener" style="color: #0f3460;">Website</a>{% endif %}
              </div>
            {% endif %}
          </div>
          {% if place %}
            <div class="place-time">{{ place.walk_time_min }} min walk</div>
          {% endif %}
        </div>
      {% endfor %}
    {% endif %}
  </div>
  {% endif %}

  <!-- 4. HEALTH & SAFETY CHECKS -->
  <div class="report-section">
    <h2>Health &amp; Safety Checks</h2>
    {% for check in result.tier1_checks %}
      <div class="check-row">
        <div class="check-icon {% if check.result == 'PASS' %}check-pass{% elif check.result == 'FAIL' %}check-fail{% else %}check-unknown{% endif %}">
          {% if check.result == "PASS" %}&#10003;{% elif check.result == "FAIL" %}&#10007;{% else %}?{% endif %}
        </div>
        <div class="check-text">
          <div class="check-label">{{ check.name }}</div>
          <div class="check-detail">{{ check.details }}</div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- 5. SCORE BREAKDOWN -->
  <div class="report-section">
    <h2>Score Breakdown</h2>
    {% for score in result.tier2_scores %}
      <div class="score-row">
        <div class="score-info">
          <div class="score-name">{{ score.name }}</div>
          <div class="score-detail">{{ score.details }}</div>
        </div>
        <div class="score-pts">{{ score.points }} / {{ score.max }}</div>
      </div>
    {% endfor %}

    {% if result.tier3_bonuses %}
      <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid #f0f2f5;">
        <div style="font-size: 0.85em; color: #888; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 8px;">Bonus Features</div>
        {% for bonus in result.tier3_bonuses %}
          <div class="score-row">
            <div class="score-info">
              <div class="score-name">{{ bonus.name }}</div>
              <div class="score-detail">{{ bonus.details }}</div>
            </div>
            <div class="score-pts">+{{ bonus.points }}</div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- SCORE BAR -->
    <div class="score-bar-container">
      <div class="score-bar-bg">
        <div class="score-bar-fill" style="width: {{ result.final_score }}%;"></div>
      </div>
      <div class="score-bar-label">
        <span>0</span>
        <span>Final Score: {{ result.final_score }} / 100</span>
        <span>100</span>
      </div>
    </div>

    <!-- LEGEND -->
    <div class="score-legend">
      <h3>How the score works</h3>
      <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
        Six daily-life factors are scored and normalized to 100. Bonus points (up to +15) for parking, outdoor space, and extra bedrooms.
        Properties that fail health/safety checks are disqualified before scoring.
      </p>
      <div class="legend-row">
        <span class="cat">Park &amp; Green Access</span>
        <span class="pts">0-10 pts</span>
      </div>
      <div class="legend-row">
        <span class="cat">Third Place (cafe, social)</span>
        <span class="pts">0-10 pts</span>
      </div>
      <div class="legend-row">
        <span class="cat">Provisioning (grocery)</span>
        <span class="pts">0-10 pts</span>
      </div>
      <div class="legend-row">
        <span class="cat">Fitness Access</span>
        <span class="pts">0-10 pts</span>
      </div>
      <div class="legend-row">
        <span class="cat">Cost / Affordability</span>
        <span class="pts">0-10 pts</span>
      </div>
      <div class="legend-row">
        <span class="cat">Transit Access</span>
        <span class="pts">0-10 pts</span>
      </div>
      <div class="legend-row" style="border-top: 1px solid #e0e0e0; margin-top: 6px; padding-top: 6px;">
        <span class="cat">Bonus (parking, outdoor, 3+ BR)</span>
        <span class="pts">up to +15</span>
      </div>
    </div>
  </div>

  {% endif %} {# end passed_tier1 #}

  {% if not result.passed_tier1 %}
  <!-- DISQUALIFIED -->
  <div class="report-section" style="border: 2px solid #fca5a5;">
    <h2 style="color: #991b1b; border-bottom-color: #fca5a5;">Disqualified</h2>
    <p style="color: #991b1b; margin-bottom: 16px;">This address failed one or more health and safety requirements. Detailed scoring is only available for qualifying addresses.</p>
    {% for check in result.tier1_checks %}
      <div class="check-row">
        <div class="check-icon {% if check.result == 'PASS' %}check-pass{% elif check.result == 'FAIL' %}check-fail{% else %}check-unknown{% endif %}">
          {% if check.result == "PASS" %}&#10003;{% elif check.result == "FAIL" %}&#10007;{% else %}?{% endif %}
        </div>
        <div class="check-text">
          <div class="check-label">{{ check.name }}</div>
          <div class="check-detail">{{ check.details }}</div>
        </div>
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- WHAT'S MISSING / NEEDS VERIFICATION -->
  {% set unknown_checks = [] %}
  {% for check in result.tier1_checks %}
    {% if check.result == "UNKNOWN" %}
      {% if unknown_checks.append(check) %}{% endif %}
    {% endif %}
  {% endfor %}
  {% if unknown_checks %}
  <div class="report-section missing-section">
    <h2>Needs Verification</h2>
    <p style="font-size: 0.88em; color: #92400e; margin-bottom: 12px;">These items could not be checked automatically. Verify with the listing or landlord.</p>
    {% for check in unknown_checks %}
      <div class="missing-item">
        <div class="missing-bullet">&#9744;</div>
        <div>
          <div class="missing-text"><strong>{{ check.name }}:</strong> {{ check.details }}</div>
        </div>
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- CTA -->
  <div class="cta-banner">
    <h3>Want to export or share this report?</h3>
    <p>Save a clean PDF or share a link with your family. Coming soon.</p>
    <a href="/pricing" class="cta-btn">View Pricing</a>
  </div>

  <!-- DISCLAIMER -->
  <div class="disclaimer">
    <strong>Disclaimer:</strong> NestCheck is a decision-support tool, not professional real estate, health, or legal advice.
    Scores are estimates based on publicly available data. Verify listing details, school assignments, and environmental conditions independently.
    <br><br>
    <strong>Data sources:</strong> Google Maps Platform (Places, Distance Matrix, Geocoding), OpenStreetMap (road classification via Overpass API).
    Walk Score data shown when available. School and childcare results are from Google Places and may not reflect official district assignments.
  </div>

</div>
{% endif %}

<!-- FOOTER -->
<footer>
  NestCheck &middot; Decision support for families optimizing daily life.
</footer>

<script>
  document.getElementById('evalForm').addEventListener('submit', function() {
    var btn = document.getElementById('evalBtn');
    var overlay = document.getElementById('loadingOverlay');
    btn.disabled = true;
    btn.textContent = 'Evaluating...';
    overlay.classList.add('active');
  });
</script>

</body>
</html>
