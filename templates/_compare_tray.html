{# ================================================================== #}
{# Comparison tray — localStorage-powered floating bar.               #}
{# Included by _base.html on every page. Manages a compare set of    #}
{# up to 4 snapshot IDs, syncs with page-level buttons/checkboxes.   #}
{# ================================================================== #}

<div id="compareTray" class="compare-tray" style="display:none">
  <div class="compare-tray__inner">
    <div class="compare-tray__list" id="compareTrayList"></div>
    <div class="compare-tray__actions">
      <button id="compareTrayBtn" class="compare-tray__compare-btn" disabled>Compare now</button>
      <button id="compareTrayClear" class="compare-tray__clear-btn">Clear</button>
    </div>
  </div>
</div>

<style>
.compare-tray {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  border-top: 1px solid var(--color-border, #e0e0e0);
  box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
  z-index: 1000;
  padding: 0.75rem 1rem;
}
.compare-tray__inner {
  max-width: 960px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex-wrap: wrap;
}
.compare-tray__list {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  flex: 1;
  align-items: center;
}
.compare-tray__count {
  font-weight: 600;
  font-size: 0.9rem;
  white-space: nowrap;
  color: var(--color-text, #1f2937);
}
.compare-tray__item {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  background: var(--color-surface-alt, #f1f5f9);
  border: 1px solid var(--color-border, #e0e0e0);
  border-radius: 4px;
  padding: 0.2rem 0.4rem;
  font-size: 0.8rem;
  max-width: 220px;
}
.compare-tray__item-address {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.compare-tray__item-remove {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--color-text-muted, #555);
  font-size: 1rem;
  line-height: 1;
  padding: 0 0.15rem;
}
.compare-tray__item-remove:hover {
  color: var(--color-text, #1f2937);
}
.compare-tray__actions {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}
.compare-tray__compare-btn {
  padding: 0.45rem 1rem;
  background: var(--color-primary, #0f3460);
  color: #fff;
  border: none;
  border-radius: 6px;
  font-size: 0.85rem;
  cursor: pointer;
  white-space: nowrap;
}
.compare-tray__compare-btn:disabled {
  opacity: 0.45;
  cursor: not-allowed;
}
.compare-tray__clear-btn {
  background: none;
  border: none;
  color: var(--color-text-muted, #555);
  font-size: 0.8rem;
  cursor: pointer;
  text-decoration: underline;
}
body.compare-tray-visible {
  padding-bottom: 70px;
}
@media print {
  .compare-tray { display: none !important; }
  body.compare-tray-visible { padding-bottom: 0; }
}
@media (max-width: 600px) {
  .compare-tray__item { max-width: 160px; }
  .compare-tray__inner { gap: 0.5rem; }
}

/* Snapshot page: compare add/remove button variants */
.compare-btn--remove {
  border: 1px solid var(--color-border, #e0e0e0) !important;
  background: transparent !important;
  color: var(--color-text-muted, #555) !important;
}
.compare-btn--full {
  opacity: 0.5;
}
</style>

<script>
(function() {
  var STORAGE_KEY = 'nestcheck_compare_ids';
  var MAX_ITEMS = 4;

  function getCompareList() {
    try {
      var raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch(e) { return []; }
  }

  function saveCompareList(list) {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }
    catch(e) {}
  }

  function normalizeAddress(addr) {
    return (addr || '').toLowerCase().replace(/\s+/g, ' ').trim();
  }

  function addToCompare(id, address) {
    var list = getCompareList();
    // Already in list by ID — nothing to do
    for (var i = 0; i < list.length; i++) {
      if (list[i].id === id) return false;
    }
    // Dedupe by address: replace older snapshot for the same address
    var norm = normalizeAddress(address);
    if (norm) {
      for (var i = 0; i < list.length; i++) {
        if (normalizeAddress(list[i].address) === norm) {
          list[i] = {id: id, address: address};
          saveCompareList(list);
          renderTray();
          return true;
        }
      }
    }
    if (list.length >= MAX_ITEMS) return false;
    list.push({id: id, address: address});
    saveCompareList(list);
    renderTray();
    return true;
  }

  function removeFromCompare(id) {
    var list = getCompareList();
    var newList = [];
    for (var i = 0; i < list.length; i++) {
      if (list[i].id !== id) newList.push(list[i]);
    }
    saveCompareList(newList);
    renderTray();
  }

  function removeFromCompareByAddress(address) {
    var norm = normalizeAddress(address);
    if (!norm) return;
    var list = getCompareList();
    var newList = [];
    for (var i = 0; i < list.length; i++) {
      if (normalizeAddress(list[i].address) !== norm) newList.push(list[i]);
    }
    saveCompareList(newList);
    renderTray();
  }

  function clearCompare() {
    saveCompareList([]);
    renderTray();
  }

  function isInCompare(id) {
    var list = getCompareList();
    for (var i = 0; i < list.length; i++) {
      if (list[i].id === id) return true;
    }
    return false;
  }

  function isAddressInCompare(address) {
    var norm = normalizeAddress(address);
    if (!norm) return false;
    var list = getCompareList();
    for (var i = 0; i < list.length; i++) {
      if (normalizeAddress(list[i].address) === norm) return true;
    }
    return false;
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }

  function escapeAttr(str) {
    return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function renderTray() {
    var tray = document.getElementById('compareTray');
    var listEl = document.getElementById('compareTrayList');
    var btn = document.getElementById('compareTrayBtn');
    if (!tray || !listEl || !btn) return;

    var list = getCompareList();

    if (list.length === 0) {
      tray.style.display = 'none';
      document.body.classList.remove('compare-tray-visible');
      updatePageButtons();
      return;
    }

    tray.style.display = '';
    document.body.classList.add('compare-tray-visible');

    // Build item chips
    var html = '<span class="compare-tray__count">' + list.length +
               ' address' + (list.length !== 1 ? 'es' : '') + ' selected</span>';
    for (var i = 0; i < list.length; i++) {
      var addr = list[i].address;
      var truncated = addr.length > 30 ? addr.substring(0, 30) + '\u2026' : addr;
      html += '<span class="compare-tray__item">' +
        '<span class="compare-tray__item-address" title="' + escapeAttr(addr) + '">' + escapeHtml(truncated) + '</span>' +
        '<button class="compare-tray__item-remove" data-id="' + escapeAttr(list[i].id) + '" title="Remove">&times;</button>' +
        '</span>';
    }
    listEl.innerHTML = html;

    // Bind remove buttons
    var removeBtns = listEl.querySelectorAll('.compare-tray__item-remove');
    for (var j = 0; j < removeBtns.length; j++) {
      removeBtns[j].addEventListener('click', function() {
        removeFromCompare(this.dataset.id);
      });
    }

    // Compare button state
    if (list.length >= 2) {
      btn.disabled = false;
      btn.textContent = 'Compare now (' + list.length + ')';
    } else {
      btn.disabled = true;
      btn.textContent = 'Compare now';
    }

    updatePageButtons();
  }

  function updatePageButtons() {
    // Update "Add to comparison" button on snapshot/result pages
    var addBtn = document.getElementById('compareAddBtn');
    if (addBtn) {
      var sid = addBtn.dataset.snapshotId;
      var list = getCompareList();
      if (isInCompare(sid) || isAddressInCompare(addBtn.dataset.snapshotAddress)) {
        addBtn.textContent = 'Remove from comparison';
        addBtn.classList.add('compare-btn--remove');
        addBtn.classList.remove('compare-btn--full');
        addBtn.disabled = false;
        addBtn.title = '';
      } else if (list.length >= MAX_ITEMS) {
        addBtn.textContent = 'Add to comparison';
        addBtn.classList.remove('compare-btn--remove');
        addBtn.classList.add('compare-btn--full');
        addBtn.disabled = true;
        addBtn.title = 'Maximum 4 addresses';
      } else {
        addBtn.textContent = 'Add to comparison';
        addBtn.classList.remove('compare-btn--remove', 'compare-btn--full');
        addBtn.disabled = false;
        addBtn.title = '';
      }
    }

    // Update my-reports checkboxes
    var checkboxes = document.querySelectorAll('.compare-checkbox');
    for (var i = 0; i < checkboxes.length; i++) {
      checkboxes[i].checked = isInCompare(checkboxes[i].dataset.snapshotId);
    }
    updateMyReportsButton();
  }

  function updateMyReportsButton() {
    var btn = document.getElementById('compareSelectedBtn');
    if (!btn) return;
    var list = getCompareList();
    if (list.length >= 2) {
      btn.disabled = false;
      btn.textContent = 'Compare selected (' + list.length + ')';
    } else {
      btn.disabled = true;
      btn.textContent = 'Compare selected';
    }
  }

  // Expose globally for external callers
  window.NestCheckCompare = {
    getList: getCompareList,
    add: addToCompare,
    remove: removeFromCompare,
    clear: clearCompare,
    isIn: isInCompare,
    render: renderTray
  };

  // -- Bind event handlers --

  // Tray "Compare now" button
  var trayBtn = document.getElementById('compareTrayBtn');
  if (trayBtn) {
    trayBtn.addEventListener('click', function() {
      var list = getCompareList();
      if (list.length >= 2) {
        var ids = [];
        for (var i = 0; i < list.length; i++) ids.push(encodeURIComponent(list[i].id));
        window.location.href = '/compare?ids=' + ids.join(',');
      }
    });
  }

  // Tray "Clear" button
  var clearBtn = document.getElementById('compareTrayClear');
  if (clearBtn) {
    clearBtn.addEventListener('click', function() { clearCompare(); });
  }

  // Snapshot page "Add to comparison" button
  var addBtn = document.getElementById('compareAddBtn');
  if (addBtn) {
    addBtn.addEventListener('click', function() {
      var sid = this.dataset.snapshotId;
      var address = this.dataset.snapshotAddress;
      if (isInCompare(sid)) {
        removeFromCompare(sid);
      } else if (isAddressInCompare(address)) {
        removeFromCompareByAddress(address);
      } else {
        addToCompare(sid, address);
      }
    });
  }

  // My Reports checkboxes
  var checkboxes = document.querySelectorAll('.compare-checkbox');
  for (var ci = 0; ci < checkboxes.length; ci++) {
    checkboxes[ci].addEventListener('change', function() {
      var sid = this.dataset.snapshotId;
      var address = this.dataset.snapshotAddress;
      if (this.checked) {
        if (!addToCompare(sid, address)) {
          // List full — uncheck
          this.checked = false;
        }
      } else {
        removeFromCompare(sid);
      }
    });
  }

  // My Reports "Compare selected" button
  var compareSelectedBtn = document.getElementById('compareSelectedBtn');
  if (compareSelectedBtn) {
    compareSelectedBtn.addEventListener('click', function() {
      var list = getCompareList();
      if (list.length >= 2) {
        var ids = [];
        for (var i = 0; i < list.length; i++) ids.push(encodeURIComponent(list[i].id));
        window.location.href = '/compare?ids=' + ids.join(',');
      }
    });
  }

  // Cross-tab sync: re-render when another tab changes the compare list
  window.addEventListener('storage', function(e) {
    if (e.key === STORAGE_KEY) {
      renderTray();
    }
  });

  // Initial render
  renderTray();
})();
</script>
