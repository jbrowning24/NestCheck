{# ================================================================== #}
{# Shared result rendering partial â€” included by index.html and       #}
{# snapshot.html. Expects: result, snapshot_id, is_snapshot,          #}
{# is_builder (optional).                                             #}
{# ================================================================== #}

{% macro fmt_time(minutes, mode) %}{% set m = minutes | int %}{% if m >= 60 %}{{ m // 60 }} hr {{ m % 60 }} min {{ mode }}{% else %}{{ m }} min {{ mode }}{% endif %}{% endmacro %}

<div class="report">

  {# â”€â”€ 1. VERDICT + SCORE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {% set show_score = result.show_score if result.show_score is defined else result.passed_tier1 %}
  <div class="verdict-card{% if not show_score %} score-failed{% endif %}">
    <div class="verdict-address">{{ result.address }}</div>

    {% if show_score %}
    <div class="score-header">
      <div class="score-number">{{ result.final_score }}</div>
      <div class="score-details">
        {% if result.score_band is defined and result.score_band %}
          <div class="score-band">{{ result.score_band }}</div>
        {% else %}
          <div class="score-band">{{ result.verdict }}</div>
        {% endif %}
        <div class="score-scale">out of 100</div>
      </div>
    </div>
    {% endif %}

    {% if result.dimension_summaries is defined and result.dimension_summaries %}
    <div class="dimension-list">
      {% for dim in result.dimension_summaries %}
      <div class="dimension-row">
        <div class="dimension-name">{{ dim.name }}</div>
        <div class="dimension-summary">{{ dim.summary }}</div>
        <div class="dimension-score">{{ dim.score }}/{{ dim.max_score }}</div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>

  {# â”€â”€ 2. NEIGHBORHOOD MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {% if result.neighborhood_map is defined and result.neighborhood_map %}
  <div id="neighborhood-map" class="report-section"
       style="text-align: center; padding: 0; overflow: hidden;
              border-radius: 8px;">
    <img src="data:image/png;base64,{{ result.neighborhood_map }}"
         alt="Neighborhood map showing nearby amenities"
         style="width: 100%; height: auto; display: block;"
         loading="lazy">
    <div style="font-size: 0.75em; color: #94a3b8; padding: 8px;
                text-align: right;">
      Map data &copy; OpenStreetMap contributors
    </div>
  </div>
  {% else %}
  <div id="neighborhood-map" class="report-section"
       style="background: #f8f9fa; min-height: 120px;
              display: flex; align-items: center;
              justify-content: center; color: #94a3b8;
              border-radius: 8px; font-size: 0.9em;">
    Map not available for this evaluation
  </div>
  {% endif %}

  {# â”€â”€ 3. YOUR NEIGHBORHOOD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {% if result.neighborhood_places is defined and result.neighborhood_places %}
  <div id="your-neighborhood" class="report-section">
    <h2>Your Neighborhood</h2>

    {% if result.insights is defined and result.insights and result.insights.your_neighborhood %}
      <p class="section-insight">{{ result.insights.your_neighborhood }}</p>
    {% endif %}

    {% set categories = [
      ("coffee", "â˜•", "Coffee & Social Spots"),
      ("grocery", "ðŸ›’", "Grocery & Essentials"),
      ("fitness", "ðŸ’ª", "Fitness & Recreation"),
      ("parks", "ðŸŒ³", "Parks & Green Space"),
    ] %}

    {% for key, icon, label in categories %}
      {% set places = result.neighborhood_places[key] | default([]) %}
      {% if places %}
      <div class="neighborhood-category">
        <div class="category-label">{{ icon }} {{ label }}</div>
        <div class="place-cards">
          {% for place in places %}
          <div class="place-card">
            <div class="place-name">
              {% if place.place_id %}
                <a href="https://www.google.com/maps/place/?q=place_id:{{ place.place_id }}"
                   target="_blank" rel="noopener noreferrer">{{ place.name }}</a>
              {% elif place.lat and place.lng %}
                <a href="https://www.google.com/maps/search/?api=1&query={{ place.lat }},{{ place.lng }}"
                   target="_blank" rel="noopener noreferrer">{{ place.name }}</a>
              {% else %}
                {{ place.name }}
              {% endif %}
            </div>
            <div class="place-meta">
              {% if place.rating %}
                <span class="place-rating">{{ "%.1f"|format(place.rating) }} â˜…</span>
              {% endif %}
              {% if place.review_count %}
                <span class="place-reviews">({{ place.review_count }})</span>
              {% endif %}
            </div>
            <div class="place-time">{{ fmt_time(place.walk_time_min, "walk") }}</div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    {% endfor %}

  </div>
  {% else %}
  <div id="your-neighborhood" class="report-section" style="display: none;">
    {# Fallback for old snapshots without neighborhood_places #}
  </div>
  {% endif %}

  {# â”€â”€ 4. GETTING AROUND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <div class="report-section">
    <h2>Getting Around</h2>

    {% if result.insights is defined and result.insights and result.insights.getting_around %}
      <p class="section-insight">{{ result.insights.getting_around }}</p>
    {% endif %}

    {# Primary Transit Node â€” rail stations, or bus stop fallback #}
    {% if result.urban_access and result.urban_access.primary_transit %}
      {% set pt = result.urban_access.primary_transit %}
      <div style="font-size: 0.82em; color: #888; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 8px;">Nearest Transit</div>
      <div class="hub-row">
        <div class="hub-info">
          <div class="hub-name">{{ pt.name }}</div>
          <div class="hub-detail">
            {{ pt.mode }}
            {% if result.frequency_label %} &middot; {{ result.frequency_label }}{% endif %}
            {% if pt.parking_available %} &middot; parking available{% endif %}
          </div>
        </div>
        <div class="hub-right">
          <span class="hub-time">{{ fmt_time(pt.walk_time_min, "walk") }}</span>
          {% if pt.drive_time_min %}
            <span style="font-size: 0.82em; color: #888;">/ {{ fmt_time(pt.drive_time_min, "drive") }}</span>
          {% endif %}
        </div>
      </div>
    {% elif result.transit_access and result.transit_access.primary_stop %}
      <div style="font-size: 0.82em; color: #888; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 8px;">Nearest Transit</div>
      <div class="hub-row">
        <div class="hub-info">
          <div class="hub-name">{{ result.transit_access.primary_stop }}</div>
          <div class="hub-detail">
            ðŸšŒ Bus
            {% if result.frequency_label %} &middot; {{ result.frequency_label }}{% endif %}
          </div>
        </div>
        <div class="hub-right">
          {% if result.transit_access.walk_minutes is not none %}
            <span class="hub-time">{{ fmt_time(result.transit_access.walk_minutes, "walk") }}</span>
          {% endif %}
        </div>
      </div>
    {% endif %}


    {# Walk / Transit / Bike Scores #}
    {% set has_walk_data = result.walk_scores and (
        result.walk_scores.walk_score is not none or
        result.walk_scores.transit_score is not none or
        result.walk_scores.bike_score is not none) %}
    {% if has_walk_data %}
      <div class="walkscore-row">
        {% if result.walk_scores.walk_score is not none %}
          <div class="walkscore-pill">
            <div class="ws-label">Walk Score</div>
            <div class="ws-value">{{ result.walk_scores.walk_score }}</div>
            {% if result.walk_scores.walk_description %}
              <div class="ws-desc">{{ result.walk_scores.walk_description }}</div>
            {% endif %}
          </div>
        {% endif %}
        {% if result.walk_scores.transit_score is not none %}
          <div class="walkscore-pill">
            <div class="ws-label">Transit Score</div>
            <div class="ws-value">{{ result.walk_scores.transit_score }}</div>
            {% if result.walk_scores.transit_description %}
              <div class="ws-desc">{{ result.walk_scores.transit_description }}</div>
            {% endif %}
          </div>
        {% endif %}
        {% if result.walk_scores.bike_score is not none %}
          <div class="walkscore-pill">
            <div class="ws-label">Bike Score</div>
            <div class="ws-value">{{ result.walk_scores.bike_score }}</div>
            {% if result.walk_scores.bike_description %}
              <div class="ws-desc">{{ result.walk_scores.bike_description }}</div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    {% endif %}

    {% if not result.urban_access and not result.transit_access and not has_walk_data %}
      <p class="section-empty">No transit options found near this address.</p>
    {% endif %}

  </div>

  {# â”€â”€ 5. PARKS & GREEN SPACE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <div class="report-section">
    <h2>Parks &amp; Green Space</h2>

    {% if result.insights is defined and result.insights and result.insights.parks %}
      <p class="section-insight">{{ result.insights.parks }}</p>
    {% endif %}

    {% if result.green_escape and result.green_escape.best_daily_park %}
      {% set park = result.green_escape.best_daily_park %}
      <div style="margin-bottom: 16px;">
        <div class="place-item" style="border-bottom: none; padding-bottom: 4px;">
          <div>
            <div class="place-name">{{ park.name }}</div>
            <div class="place-meta">
              {% if park.rating %}{{ "%.1f"|format(park.rating) }} stars{% endif %}
              {% if park.user_ratings_total %} ({{ park.user_ratings_total }} reviews){% endif %}
              {% if park.types_display %} &middot; {{ park.types_display }}{% endif %}
            </div>
          </div>
          <div style="text-align: right;">
            <div class="place-time">{% if park.drive_time_min and park.walk_time_min > 30 %}{{ fmt_time(park.drive_time_min, "drive") }}{% else %}{{ fmt_time(park.walk_time_min, "walk") }}{% endif %}</div>
            <div style="font-size: 0.82em; color: #666; margin-top: 2px;">
              Daily Value: <strong style="color: {% if park.daily_walk_value >= 7 %}#065f46{% elif park.daily_walk_value >= 5 %}#856404{% else %}#991b1b{% endif %};">{{ "%.1f"|format(park.daily_walk_value) }}/10</strong>
            </div>
          </div>
        </div>

        {# Subscore breakdown #}
        {% if park.subscores %}
        <div class="subscore-grid">
          {% for ss in park.subscores %}
            <div class="subscore-card">
              <div class="subscore-label">
                {{ ss.name }}{% if ss.is_estimate %} <span class="est">(est)</span>{% endif %}
              </div>
              <div class="subscore-value">{{ "%.1f"|format(ss.score) }} / {{ "%.0f"|format(ss.max_score) }}</div>
              <div class="subscore-reason">{{ ss.reason }}</div>
            </div>
          {% endfor %}
        </div>
        {% endif %}

        {# OSM data note #}
        {% if park.osm_enriched %}
          <div style="margin-top: 8px; font-size: 0.78em; color: #888;">
            OpenStreetMap: {% if park.osm_area_sqm %}~{{ "%.0f"|format(park.osm_area_sqm / 4047) }} acres{% endif %}
            {% if park.osm_path_count %} &middot; {{ park.osm_path_count }} paths{% endif %}
            {% if park.osm_has_trail %} &middot; trail detected{% endif %}
          </div>
        {% endif %}
      </div>

    {% else %}
      <p class="section-empty">No major green space found within walking distance.</p>
    {% endif %}

    {# Other nearby green spaces #}
    {% if result.green_escape and result.green_escape.nearby_green_spaces %}
      <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid #f0f0f0;">
        <div style="font-size: 0.82em; color: #888; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 8px;">Other nearby green spaces</div>
        {% for space in result.green_escape.nearby_green_spaces[:5] %}
          <div class="place-item">
            <div>
              <div class="place-name" style="font-weight: 500;">
                {{ space.name }}
                {# Distance-based label: â‰¤10 min Very Close, 11-20 Walkable, 21-30 Moderate, >30 Drive Only #}
                {% if space.walk_time_min <= 10 %}
                  {% set dist_label, dist_badge = "Very Close", "badge-pass" %}
                {% elif space.walk_time_min <= 20 %}
                  {% set dist_label, dist_badge = "Walkable", "badge-pass" %}
                {% elif space.walk_time_min <= 30 %}
                  {% set dist_label, dist_badge = "Moderate", "badge-borderline" %}
                {% else %}
                  {% set dist_label, dist_badge = "Drive Only", "badge-fail" %}
                {% endif %}
                <span class="badge {{ dist_badge }}" style="margin-left: 6px;">{{ dist_label }}</span>
              </div>
              <div class="place-meta">
                {% if space.rating %}{{ "%.1f"|format(space.rating) }} stars{% endif %}
                {% if space.user_ratings_total %} ({{ space.user_ratings_total }} reviews){% endif %}
                &middot; Score: {{ "%.1f"|format(space.daily_walk_value) }}/10
              </div>
            </div>
            <div class="place-time">{% if space.drive_time_min and space.walk_time_min > 30 %}{{ fmt_time(space.drive_time_min, "drive") }}{% else %}{{ fmt_time(space.walk_time_min, "walk") }}{% endif %}</div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

  </div>

  {# â”€â”€ 6. PROXIMITY & ENVIRONMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <div class="report-section">
    <h2>Proximity &amp; Environment</h2>

    {% if result.presented_checks is defined %}
      {% for pc in result.presented_checks %}
        {% if pc.category == "SAFETY" %}

          {# â”€â”€ New proximity-band rendering â”€â”€ #}
          {% if pc.proximity_band is defined and pc.proximity_band %}
            {% set band_class = "proximity-" + pc.proximity_band | lower %}
            <div class="proximity-item {{ band_class }}">
              <div class="proximity-name">{{ pc.headline }}</div>
              {% if pc.explanation and (pc.proximity_band != 'NEUTRAL' or pc.result_type != 'CLEAR') %}
                <div class="proximity-detail">{{ pc.explanation }}</div>
              {% endif %}
            </div>

          {# â”€â”€ Backward compat: old snapshots with presented_checks but no proximity_band â”€â”€ #}
          {% else %}
            <div class="check-row">
              <div class="check-icon {% if pc.result_type == 'CLEAR' %}check-pass{% elif pc.result_type == 'CONFIRMED_ISSUE' %}check-fail{% else %}check-unknown{% endif %}">
                {% if pc.result_type == "CLEAR" %}&#10003;{% elif pc.result_type == "CONFIRMED_ISSUE" %}&#10007;{% else %}?{% endif %}
              </div>
              <div class="check-text">
                <div class="check-label">{{ pc.display_name }}</div>
                <div class="check-detail">{{ pc.headline }}</div>
                {% if pc.explanation and pc.result_type != "CLEAR" %}
                  <div class="check-detail" style="color: #555; margin-top: 4px; font-size: 0.85em;">{{ pc.explanation }}</div>
                {% endif %}
              </div>
            </div>
          {% endif %}

        {% endif %}
      {% endfor %}
    {% else %}
      {# Fallback for very old snapshots without presented_checks #}
      {% if result.tier1_checks is defined %}
        {% for check in result.tier1_checks %}
          <div class="check-row">
            <div class="check-icon {% if check.result == 'PASS' %}check-pass{% elif check.result == 'FAIL' %}check-fail{% else %}check-unknown{% endif %}">
              {% if check.result == "PASS" %}&#10003;{% elif check.result == "FAIL" %}&#10007;{% else %}?{% endif %}
            </div>
            <div class="check-text">
              <div class="check-label">{{ check.name }}</div>
              <div class="check-detail">{{ check.details }}</div>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    {% endif %}

  </div>

  {# â”€â”€ 7. HOW WE SCORE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <div class="report-section">
    <div class="collapsible-toggle" onclick="toggleSection(this)">
      <h2>How We Score</h2>
      <span class="collapse-icon">&#9654;</span>
    </div>
    <div class="collapsible-body collapsed">

    <p class="scoring-explanation">
      NestCheck evaluates five daily-life factors, each scored 0â€“10.
      The scores are combined and normalized to a 100-point scale.
      Bonus points (up to +15) may be added for parking, outdoor space, or extra bedrooms.
    </p>

    {# Band thresholds must match SCORE_BANDS in app.py #}
    <div class="band-table">
      <div class="band-row"><span class="band-range">85â€“100</span><span class="band-label">Exceptional Daily Fit</span></div>
      <div class="band-row"><span class="band-range">70â€“84</span><span class="band-label">Strong Daily Fit</span></div>
      <div class="band-row"><span class="band-range">55â€“69</span><span class="band-label">Moderate â€” Some Trade-offs</span></div>
      <div class="band-row"><span class="band-range">40â€“54</span><span class="band-label">Limited â€” Car Likely Needed</span></div>
      <div class="band-row"><span class="band-range">0â€“39</span><span class="band-label">Significant Gaps</span></div>
    </div>

    <p class="scoring-note">
      Proximity factors (gas stations, highways, high-traffic roads)
      are reported separately and do not affect the score.
    </p>

    </div>{# .collapsible-body #}
  </div>{# .report-section #}

  {# â”€â”€ SHARE + EXPORT BAR (index only â€” snapshot has it at top) â”€â”€ #}
  {% if not is_snapshot and snapshot_id %}
  <div class="share-bar">
    <button class="share-btn" id="shareBtn" onclick="copyShareLink()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
      <span id="shareBtnText">Copy share link</span>
    </button>
    <a href="/api/snapshot/{{ snapshot_id }}/json" class="share-btn" style="text-decoration: none; background: #334155;">JSON</a>
    <a href="/api/snapshot/{{ snapshot_id }}/csv" class="share-btn" style="text-decoration: none; background: #334155;">CSV</a>
  </div>
  {% endif %}

  {# â”€â”€ CTA BANNER (snapshot only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {% if is_snapshot %}
  <div class="snapshot-cta">
    <h3>Evaluate your own address</h3>
    <p>See how any U.S. address scores for walkability, green space, transit, and daily life.</p>
    <a href="/">Try NestCheck</a>
  </div>
  {% endif %}

  {# â”€â”€ DISCLAIMER + DATA SOURCES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <div class="disclaimer">
    <strong>Disclaimer:</strong> NestCheck is a decision-support tool, not professional real estate, health, or legal advice.
    Scores are estimates based on publicly available data. Verify listing details, school assignments, and environmental conditions independently.
    <br><br>
    <strong>Data sources:</strong> Google Maps Platform (Places, Distance Matrix, Geocoding), OpenStreetMap (road classification and green space polygons via Overpass API).
    Walk Score data shown when API key is configured.
  </div>

</div>
