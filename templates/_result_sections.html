{# ================================================================== #}
{# Shared result rendering partial â€” included by index.html and       #}
{# snapshot.html. Expects: result, snapshot_id, is_snapshot,          #}
{# is_builder (optional), is_preview (optional, NES-132).             #}
{# ================================================================== #}

{# NES-132: Default is_preview to false for backward compatibility #}
{% set is_preview = is_preview if is_preview is defined else false %}

{% from "_macros.html" import fmt_time, data_row, score_ring %}

<div class="report">

  {# â”€â”€ 1. VERDICT + SCORE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {% set show_score = result.show_score if result.show_score is defined else result.passed_tier1 %}
  <div id="verdict" class="verdict-card{% if is_preview %} verdict-card--preview{% elif not show_score %} score-failed{% endif %}">
    <div class="verdict-address">{{ result.address }}</div>

    {% if is_preview %}
    {# NES-132: Health status banner instead of score ring #}
    {% set safety_checks = (result.presented_checks | default([])) | selectattr('category', 'equalto', 'SAFETY') | list %}
    {% set clear_count = safety_checks | selectattr('result_type', 'equalto', 'CLEAR') | list | length %}
    <div class="preview-health-banner">
      <div class="preview-health-title">Health &amp; Safety Check</div>
      {% if safety_checks %}
      <div class="preview-health-status {% if clear_count == (safety_checks | length) %}preview-status-clear{% else %}preview-status-concern{% endif %}">
        {{ clear_count }} of {{ safety_checks | length }} checks clear
      </div>
      {% else %}
      <div class="preview-health-status preview-status-clear">
        No environmental concerns detected near this address.
      </div>
      {% endif %}
    </div>
    {% elif show_score %}
    {% set band_class = result.score_band.css_class if result.score_band is mapping else '' %}
    {% set band_label = result.score_band.label if result.score_band is mapping else (result.score_band or result.verdict) %}
    <div class="score-header">
      {{ score_ring(result.final_score, band_class, 'score-ring-container') }}
      <div class="score-details">
        <div class="score-band {{ band_class }}">{{ band_label }}</div>
        <div class="score-scale">out of 100</div>
      </div>
    </div>
    {% else %}
    {# Disqualified â€” property failed tier 1 safety checks (NES-164) #}
    <div class="verdict-failed-banner">
      <div class="verdict-failed-title">Health &amp; Safety Concerns</div>
      {% if result.structured_summary is defined and result.structured_summary %}
        <div class="verdict-failed-summary">{{ result.structured_summary }}</div>
      {% endif %}
      <div class="verdict-failed-explanation">Detailed scoring is only available for qualifying addresses.</div>
    </div>
    {% endif %}

    {# Persona badge â€” only shown for non-balanced personas (NES-133) #}
    {% if result.persona is defined and result.persona and result.persona.key != 'balanced' %}
    <div class="persona-badge">
      Scored as: <strong>{{ result.persona.label }}</strong>
    </div>
    {% endif %}

    {# Dimension summaries â€” full report only #}
    {% if not is_preview and result.dimension_summaries is defined and result.dimension_summaries %}
    <div class="dimension-list">
      {% for dim in result.dimension_summaries %}
      {% set dim_weight = result.persona.weights[dim.name] if result.persona is defined and result.persona and result.persona.weights is defined and dim.name in (result.persona.weights or {}) else 1.0 %}
      {% call(slot) data_row(name=dim.name, detail=dim.summary, variant="dimension") %}
        {% if slot == "right" %}
        <div class="dimension-indicator">
          <span class="dimension-score">{{ dim.score }}/{{ dim.max_score }}</span>
          {% if dim_weight > 1.0 %}
            <span class="dimension-weight-badge weight-up" title="{{ '%.0f'|format(dim_weight * 100) }}% weight">&#9650;</span>
          {% elif dim_weight < 1.0 %}
            <span class="dimension-weight-badge weight-down" title="{{ '%.0f'|format(dim_weight * 100) }}% weight">&#9660;</span>
          {% endif %}
          <div class="dimension-bar">
            <div class="dimension-bar-fill" style="--fill: {{ ((dim.score / dim.max_score * 100) | int) if dim.max_score else 0 }}%"></div>
          </div>
        </div>
        {% endif %}
      {% endcall %}
      {% endfor %}
    </div>
    {% endif %}

    {# Safety concern pills â€” shown in BOTH preview and full #}
    {% set safety_concerns = (result.presented_checks | default([])) | selectattr('category', 'equalto', 'SAFETY') | selectattr('result_type', 'ne', 'CLEAR') | list %}
    {% if safety_concerns %}
    <div class="verdict-proximity-flags">
      {% for pc in safety_concerns %}
      <span class="verdict-proximity-pill proximity-{{ (pc.proximity_band or 'neutral') | lower }}">âš  {{ pc.headline }}</span>
      {% endfor %}
    </div>
    {% endif %}
  </div>

  {# â”€â”€ CONTEXTUAL SHARE PROMPT (snapshot only â€” NES-123) â”€â”€â”€â”€ #}
  {% if is_snapshot is defined and is_snapshot %}
  {% set band = result.score_band.css_class if result.score_band is mapping else '' %}
  <div class="share-prompt {{ band }}">
    <div class="share-prompt-text">
      {% if band == 'band-exceptional' %}
        This property is a standout â€” share this report with your household.
      {% elif band == 'band-strong' %}
        This property looks promising â€” send it to someone who should see it.
      {% elif band == 'band-moderate' %}
        Considering this property? Share the evaluation and talk it over.
      {% elif band == 'band-limited' %}
        Some trade-offs here â€” share this report and get another perspective.
      {% else %}
        Every evaluation helps narrow the search â€” share to keep everyone in the loop.
      {% endif %}
    </div>
    <button class="share-btn" onclick="(typeof nativeShare==='function' && navigator.share ? nativeShare : copyShareLink)(this)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
      Share this report
    </button>
  </div>
  {% endif %}

  {# â”€â”€ SUMMARY NARRATIVE â”€â”€â”€ #}
  {% if result.summary_narrative is defined and result.summary_narrative %}
  <div class="summary-narrative" style="margin: 1.5rem 0 2rem; line-height: 1.65; color: #2d2d2d; font-size: 1.05rem; overflow-wrap: break-word;">
    {{ result.summary_narrative | safe }}
  </div>
  {% endif %}

  {# â”€â”€ 2. NEIGHBORHOOD MAP (interactive Leaflet.js â€” NES-38) â”€â”€â”€ #}
  {% set has_map_data = result.coordinates is defined and result.coordinates
                        and result.neighborhood_places is defined and result.neighborhood_places %}
  {% if has_map_data %}
  {% set _map_suffix = '-' ~ compare_index if compare_index is defined and compare_index else '' %}
  <div id="neighborhood-map{{ _map_suffix }}" class="report-section map-container report-map-inline">
    <div id="neighborhood-map-leaflet{{ _map_suffix }}" class="map-leaflet"></div>
  </div>
  {# Embed map data as JSON for neighborhood-map.js â€” no extra API calls #}
  {% set transit = (result.urban_access.primary_transit
                    if result.urban_access is defined and result.urban_access
                       and result.urban_access.primary_transit is defined
                    else none) %}
  <script id="nc-map-data{{ _map_suffix }}" type="application/json">
  {{ {
    "coordinates": result.coordinates,
    "neighborhood_places": result.neighborhood_places,
    "transit": {"name": transit.name, "lat": transit.lat, "lng": transit.lng,
                "walk_time_min": transit.walk_time_min} if transit and transit.lat is defined else none
  } | tojson }}
  </script>
  {% else %}
  {% set _map_suffix = '-' ~ compare_index if compare_index is defined and compare_index else '' %}
  <div id="neighborhood-map{{ _map_suffix }}" class="report-section map-placeholder report-map-inline">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
      <line x1="9" y1="9" x2="15" y2="9"/>
    </svg>
    Map not available for this evaluation
  </div>
  {% endif %}

  {# â”€â”€ 3. YOUR NEIGHBORHOOD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {% if result.neighborhood_places is defined and result.neighborhood_places %}
  <div id="your-neighborhood" class="report-section">
    <h2>Your Neighborhood</h2>

    {% if result.insights is defined and result.insights and result.insights.your_neighborhood %}
      <p class="section-insight">{{ result.insights.your_neighborhood }}</p>
    {% endif %}

    {% set categories = [
      ("coffee", "â˜•", "Coffee & Social Spots"),
      ("grocery", "ðŸ›’", "Grocery & Essentials"),
      ("fitness", "ðŸ’ª", "Fitness & Recreation"),
      ("parks", "ðŸŒ³", "Parks & Green Space"),
    ] %}

    {% for key, icon, label in categories %}
      {% set places = result.neighborhood_places[key] | default([]) %}
      {# Separate normal results from expanded-search (wider radius) results #}
      {% set normal_places = places | selectattr("expanded_search", "undefined") | list
         if places else [] %}
      {% set expanded_places = places | selectattr("expanded_search", "defined")
         | selectattr("expanded_search") | list if places else [] %}

      {% if normal_places %}
      {# â”€â”€ Normal results: places within walking distance â”€â”€ #}
      <div class="neighborhood-category">
        <div class="category-label">{{ icon }} {{ label }}</div>
        <div class="place-cards">
          {% for place in normal_places %}
          {% set is_headline = loop.first and place.review_snippet %}
          <div class="place-card{% if is_headline %} place-card--headline{% endif %}">
            <div class="place-name">
              {% if place.place_id %}
                <a href="https://www.google.com/maps/place/?q=place_id:{{ place.place_id }}"
                   target="_blank" rel="noopener noreferrer">{{ place.name }}</a>
              {% elif place.lat and place.lng %}
                <a href="https://www.google.com/maps/search/?api=1&query={{ place.lat }},{{ place.lng }}"
                   target="_blank" rel="noopener noreferrer">{{ place.name }}</a>
              {% else %}
                {{ place.name }}
              {% endif %}
            </div>
            <div class="place-meta">
              {% if place.rating %}
                <span class="place-rating">{{ "%.1f"|format(place.rating) }} â˜…</span>
              {% endif %}
              {% if place.review_count %}
                <span class="place-reviews">({{ place.review_count }})</span>
              {% endif %}
            </div>
            {% if place.review_snippet %}
            <div class="place-snippet">
              "{{ place.review_snippet }}"
              {% if place.review_time %}
                <span class="place-snippet-time">&mdash; {{ place.review_time }}</span>
              {% endif %}
            </div>
            {% endif %}
            <div class="place-time">
              {# Drive/walk display: â‰¤20 walk only, 21-40 both, >40 drive only #}
              {% if place.drive_time_min and (place.walk_time_min or 0) > 40 %}
                {{ fmt_time(place.drive_time_min, "drive") }}
              {% elif place.drive_time_min and (place.walk_time_min or 0) > 20 %}
                {{ fmt_time(place.walk_time_min, "walk") }} Â· {{ fmt_time(place.drive_time_min, "drive") }}
              {% else %}
                {{ fmt_time(place.walk_time_min, "walk") }}
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      {% elif expanded_places and key != "parks" %}
      {# â”€â”€ Expanded results: nearest by car when nothing walkable â”€â”€ #}
      <div class="neighborhood-category neighborhood-category--expanded">
        <div class="category-label">{{ icon }} {{ label }}</div>
        <p class="expanded-search-note">None within walking distance &mdash; nearest by car:</p>
        <div class="place-cards">
          {% for place in expanded_places %}
          <div class="place-card place-card--muted">
            <div class="place-name">
              {% if place.place_id %}
                <a href="https://www.google.com/maps/place/?q=place_id:{{ place.place_id }}"
                   target="_blank" rel="noopener noreferrer">{{ place.name }}</a>
              {% elif place.lat and place.lng %}
                <a href="https://www.google.com/maps/search/?api=1&query={{ place.lat }},{{ place.lng }}"
                   target="_blank" rel="noopener noreferrer">{{ place.name }}</a>
              {% else %}
                {{ place.name }}
              {% endif %}
            </div>
            <div class="place-meta">
              {% if place.rating %}
                <span class="place-rating">{{ "%.1f"|format(place.rating) }} â˜…</span>
              {% endif %}
            </div>
            <div class="place-time">
              {% if place.drive_time_min %}
                {{ fmt_time(place.drive_time_min, "drive") }}
              {% else %}
                Drive time unavailable
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      {% elif key != "parks" %}
      {# â”€â”€ Truly empty: nothing found even at wider radius â”€â”€ #}
      <div class="neighborhood-category neighborhood-category--empty">
        <div class="category-label">{{ icon }} {{ label }}</div>
        <p class="section-empty">No {{ label | lower }} found within about 10 miles.</p>
      </div>
      {% endif %}
    {% endfor %}

  </div>
  {% else %}
  <div id="your-neighborhood" class="report-section hidden">
    {# Fallback for old snapshots without neighborhood_places #}
  </div>
  {% endif %}

  {# â”€â”€ 4. GETTING AROUND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <div id="getting-around" class="report-section">
    <h2>Getting Around</h2>

    {% if result.insights is defined and result.insights and result.insights.getting_around %}
      <p class="section-insight">{{ result.insights.getting_around }}</p>
    {% endif %}

    {# Primary Transit Node â€” rail stations, or bus stop fallback #}
    {% if result.urban_access and result.urban_access.primary_transit %}
      {% set pt = result.urban_access.primary_transit %}
      <div class="section-label">Nearest Transit</div>
      {% set pt_detail %}{{ pt.mode }}{% if result.frequency_label %} &middot; {{ result.frequency_label }}{% endif %}{% if pt.parking_available %} &middot; parking available{% endif %}{% endset %}
      {% call(slot) data_row(name=pt.name, detail=pt_detail, variant="hub") %}
        {% if slot == "right" %}
          <span class="data-row__value">{{ fmt_time(pt.walk_time_min, "walk") }}</span>
          {% if pt.drive_time_min %}
            <span class="text-faint-sm">/ {{ fmt_time(pt.drive_time_min, "drive") }}</span>
          {% endif %}
        {% endif %}
      {% endcall %}

      {# Accessibility annotations â€” rail stations only (NES-31) #}
      <div class="accessibility-lines">
        <div class="accessibility-attr">
          <span class="accessibility-label">Step-free entrance:</span>
          {% if pt.wheelchair_accessible_entrance is true %}
            <span class="accessibility-val accessibility-yes">Yes</span>
          {% elif pt.wheelchair_accessible_entrance is false %}
            <span class="accessibility-val accessibility-no">No</span>
          {% else %}
            <span class="accessibility-val accessibility-unverified">Unverified &mdash; check with transit agency</span>
          {% endif %}
        </div>
        <div class="accessibility-attr">
          <span class="accessibility-label">Elevator:</span>
          {% if pt.elevator_available is true %}
            <span class="accessibility-val accessibility-yes">Yes</span>
          {% elif pt.elevator_available is false %}
            <span class="accessibility-val accessibility-no">No</span>
          {% else %}
            <span class="accessibility-val accessibility-unverified">Unverified &mdash; check with transit agency</span>
          {% endif %}
        </div>
      </div>

    {% elif result.transit_access and result.transit_access.primary_stop %}
      <div class="section-label">Nearest Transit</div>
      {% set bus_detail %}ðŸšŒ Bus{% if result.frequency_label %} &middot; {{ result.frequency_label }}{% endif %}{% endset %}
      {{ data_row(
          name=result.transit_access.primary_stop,
          detail=bus_detail,
          value=fmt_time(result.transit_access.walk_minutes, "walk") if result.transit_access.walk_minutes is not none else None,
          variant="hub"
      ) }}
    {% endif %}


    {# Walk / Transit / Bike Scores #}
    {% set has_walk_data = result.walk_scores and (
        result.walk_scores.walk_score is not none or
        result.walk_scores.transit_score is not none or
        result.walk_scores.bike_score is not none) %}
    {% if has_walk_data %}
      <div class="walkscore-row">
        {% if result.walk_scores.walk_score is not none %}
          <div class="walkscore-pill">
            <div class="ws-label">Walk Score</div>
            <div class="ws-value">{{ result.walk_scores.walk_score }}</div>
            {% if result.walk_scores.walk_description %}
              <div class="ws-desc">{{ result.walk_scores.walk_description }}</div>
            {% endif %}
          </div>
        {% endif %}
        {% if result.walk_scores.transit_score is not none %}
          <div class="walkscore-pill">
            <div class="ws-label">Transit Score</div>
            <div class="ws-value">{{ result.walk_scores.transit_score }}</div>
            {% if result.walk_scores.transit_description %}
              <div class="ws-desc">{{ result.walk_scores.transit_description }}</div>
            {% endif %}
          </div>
        {% endif %}
        {% if result.walk_scores.bike_score is not none %}
          <div class="walkscore-pill">
            <div class="ws-label">Bike Score</div>
            <div class="ws-value">{{ result.walk_scores.bike_score }}</div>
            {% if result.walk_scores.bike_description %}
              <div class="ws-desc">{{ result.walk_scores.bike_description }}</div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    {% endif %}

    {% if not result.urban_access and not result.transit_access and not has_walk_data %}
      <p class="section-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="4" y="3" width="16" height="16" rx="2"/>
          <line x1="4" y1="11" x2="20" y2="11"/>
          <circle cx="8.5" cy="16" r="1.5"/><circle cx="15.5" cy="16" r="1.5"/>
          <line x1="12" y1="3" x2="12" y2="11"/>
        </svg>
        No transit options found near this address.
      </p>
    {% endif %}

  </div>

  {# â”€â”€ 5. PARKS & GREEN SPACE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <div id="parks-green-space" class="report-section">
    <h2>Parks &amp; Green Space</h2>

    {% if result.insights is defined and result.insights and result.insights.parks %}
      <p class="section-insight">{{ result.insights.parks }}</p>
    {% endif %}

    {% if result.green_escape and result.green_escape.messages %}
      {% for msg in result.green_escape.messages %}
        <p class="eval-note">{{ msg }}</p>
      {% endfor %}
    {% endif %}

    {% if result.green_escape and result.green_escape.best_daily_park %}
      {% set park = result.green_escape.best_daily_park %}
      <div class="park-highlight">
        {% set park_meta %}{% if park.rating %}{{ "%.1f"|format(park.rating) }} stars{% endif %}{% if park.user_ratings_total %} ({{ park.user_ratings_total }} reviews){% endif %}{% if park.types_display %} &middot; {{ park.types_display }}{% endif %}{% endset %}
        {% call(slot) data_row(name=park.name, detail=park_meta, variant="place", no_border=true) %}
          {% if slot == "right" %}
          <div class="text-right">
            <div class="data-row__value">{% if park.drive_time_min and park.walk_time_min > 30 %}{{ fmt_time(park.drive_time_min, "drive") }}{% else %}{{ fmt_time(park.walk_time_min, "walk") }}{% endif %}</div>
            <div class="park-daily-value">
              Daily Value: <strong class="{% if park.daily_walk_value >= 7 %}score-good{% elif park.daily_walk_value >= 5 %}score-moderate{% else %}score-poor{% endif %}">{{ "%.1f"|format(park.daily_walk_value) }}/10</strong>
            </div>
          </div>
          {% endif %}
        {% endcall %}

        {# Subscore breakdown #}
        {% if park.subscores %}
        <div class="subscore-grid">
          {% for ss in park.subscores %}
            <div class="subscore-card">
              <div class="subscore-label">
                {{ ss.name }}{% if ss.is_estimate %} <span class="est">(est)</span>{% endif %}
              </div>
              <div class="subscore-value">{{ "%.1f"|format(ss.score) }} / {{ "%.0f"|format(ss.max_score) }}</div>
              <div class="subscore-reason">{{ ss.reason }}</div>
            </div>
          {% endfor %}
        </div>
        {% endif %}

        {# OSM data note #}
        {% if park.osm_enriched %}
          <div class="osm-note">
            OpenStreetMap: {% if park.osm_area_sqm %}~{{ "%.0f"|format(park.osm_area_sqm / 4047) }} acres{% endif %}
            {% if park.osm_path_count %} &middot; {{ park.osm_path_count }} paths{% endif %}
            {% if park.osm_has_trail %} &middot; trail detected{% endif %}
          </div>
        {% endif %}
      </div>

    {% else %}
      <p class="section-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 3 L8 10 H4 L9 15 L7 22 H17 L15 15 L20 10 H16 Z"/>
        </svg>
        No major green space found within walking distance.
      </p>
    {% endif %}

    {# Other nearby green spaces #}
    {% if result.green_escape and result.green_escape.nearby_green_spaces %}
      <div class="subsection-divider">
        <div class="section-label">Other nearby green spaces</div>
        {% for space in result.green_escape.nearby_green_spaces[:5] %}
          {# Distance-based label: â‰¤10 min Very Close, 11-20 Walkable, 21-30 Moderate, >30 Drive Only #}
          {% if space.walk_time_min <= 10 %}
            {% set dist_label, dist_badge = "Very Close", "badge-pass" %}
          {% elif space.walk_time_min <= 20 %}
            {% set dist_label, dist_badge = "Walkable", "badge-pass" %}
          {% elif space.walk_time_min <= 30 %}
            {% set dist_label, dist_badge = "Moderate", "badge-borderline" %}
          {% else %}
            {% set dist_label, dist_badge = "Drive Only", "badge-fail" %}
          {% endif %}
          {% set space_name %}<span class="place-name--light">{{ space.name }}</span> <span class="badge {{ dist_badge }} badge--inline">{{ dist_label }}</span>{% endset %}
          {% set space_meta %}{% if space.rating %}{{ "%.1f"|format(space.rating) }} stars{% endif %}{% if space.user_ratings_total %} ({{ space.user_ratings_total }} reviews){% endif %} &middot; Score: {{ "%.1f"|format(space.daily_walk_value) }}/10{% endset %}
          {{ data_row(
              name=space_name,
              detail=space_meta,
              value=fmt_time(space.drive_time_min, "drive") if space.drive_time_min and space.walk_time_min > 30 else fmt_time(space.walk_time_min, "walk"),
              variant="place"
          ) }}
        {% endfor %}
      </div>
    {% endif %}

  </div>

  {# â”€â”€ 5.5 EMERGENCY SERVICES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {# Informational only â€” nearest fire/police stations by drive time.  #}
  {# Three-state guard:                                                #}
  {#   key absent  â†’ old snapshot, hide section                        #}
  {#   value=none  â†’ lookup failed, hide section (graceful degradation)#}
  {#   value=[]    â†’ searched, found nothing, show "none found"        #}
  {#   value=[..]  â†’ found stations, show cards                        #}
  {% if result.emergency_services is defined and result.emergency_services is not none %}
  <div id="emergency-services" class="report-section">
    <h2>Emergency Services</h2>

    {% if result.emergency_services %}
      {% for svc in result.emergency_services %}
      {{ data_row(
          name=svc.name,
          detail="Fire Station" if svc.type == "fire" else "Police Station",
          value=fmt_time(svc.drive_time_min, "drive"),
          variant="hub"
      ) }}
      {% endfor %}
    {% else %}
      <p class="section-empty">No fire or police stations found within 3 miles.</p>
    {% endif %}

  </div>
  {% endif %}

  {# â”€â”€ 5.6 NEARBY LIBRARIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {# Informational only â€” nearest public libraries, estimated walk  #}
  {# times via haversine (~3 mph). Same three-state guard as         #}
  {# emergency services.                                             #}
  {% if result.nearby_libraries is defined and result.nearby_libraries is not none %}
  <div id="libraries" class="report-section">
    <h2>Libraries</h2>

    {% if result.nearby_libraries %}
      {% for lib in result.nearby_libraries %}
      {{ data_row(
          name=lib.name,
          detail="Public Library",
          value="~" ~ lib.est_walk_min ~ " min walk",
          variant="hub"
      ) }}
      {% endfor %}
      {% if result.library_count is defined and result.library_count > 0 %}
        <p class="section-footnote">{{ result.library_count }} {{ "library" if result.library_count == 1 else "libraries" }} within 1.2 mi</p>
      {% endif %}
    {% else %}
      <p class="section-empty">No public libraries found within 1.2 mi.</p>
    {% endif %}

  </div>
  {% endif %}

  {# â”€â”€ 5.7 NEARBY PHARMACIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {# Informational only â€” nearest pharmacies, estimated walk       #}
  {# times via haversine (~3 mph). Same three-state guard as       #}
  {# emergency services / libraries.                               #}
  {% if result.nearby_pharmacies is defined and result.nearby_pharmacies is not none %}
  <div id="pharmacies" class="report-section">
    <h2>Pharmacies</h2>

    {% if result.nearby_pharmacies %}
      {% for pharm in result.nearby_pharmacies %}
      {# Drive/walk display: â‰¤20 walk only, 21-40 both, >40 drive only #}
      {% if pharm.drive_time_min and (pharm.est_walk_min or 0) > 40 %}
        {% set time_val = "~" ~ pharm.drive_time_min ~ " min drive" %}
      {% elif pharm.drive_time_min and (pharm.est_walk_min or 0) > 20 %}
        {% set time_val = "~" ~ pharm.est_walk_min ~ " min walk Â· " ~ pharm.drive_time_min ~ " min drive" %}
      {% else %}
        {% set time_val = "~" ~ pharm.est_walk_min ~ " min walk" %}
      {% endif %}
      {{ data_row(
          name=pharm.name,
          detail="Pharmacy",
          value=time_val,
          variant="hub"
      ) }}
      {% endfor %}
      {% if result.pharmacy_count is defined and result.pharmacy_count > 0 %}
        <p class="section-footnote">{{ result.pharmacy_count }} {{ "pharmacy" if result.pharmacy_count == 1 else "pharmacies" }} within 1.2 mi</p>
      {% endif %}
    {% else %}
      <p class="section-empty">No pharmacies found within 1.2 mi.</p>
    {% endif %}

  </div>
  {% endif %}

  {# â”€â”€ 6. PROXIMITY & ENVIRONMENT â€” always shown (preview + full) â”€â”€ #}
  <div id="proximity-environment" class="report-section">
    <h2>Proximity &amp; Environment</h2>

    {# Section-level synthesis insight #}
    {% if result.insights is defined and result.insights and result.insights.proximity %}
      <p class="section-insight">{{ result.insights.proximity }}</p>
    {% endif %}

    {# presented_checks is guaranteed by load-time backfill (NES-80) #}
    {% set safety_items = (result.presented_checks | default([])) | selectattr('category', 'equalto', 'SAFETY') | list %}
    {% if safety_items %}
      {% for pc in safety_items %}
        {% set band_class = "proximity-" + pc.proximity_band | lower %}
        <div class="proximity-item {{ band_class }}">
          <div class="proximity-name">
            {% if pc.result_type == "CLEAR" -%}
              <span class="proximity-icon proximity-icon-clear">&#10003;</span>
            {%- elif pc.result_type == "CONFIRMED_ISSUE" -%}
              <span class="proximity-icon proximity-icon-issue">&#10007;</span>
            {%- else -%}
              <span class="proximity-icon proximity-icon-unverified">?</span>
            {%- endif %}
            {{ pc.headline }}
          </div>
          {% if pc.explanation and (pc.proximity_band != 'NEUTRAL' or pc.result_type != 'CLEAR') %}
            <div class="proximity-detail">{{ pc.explanation }}</div>
          {% endif %}
          {# Satellite link for unverified checks #}
          {% if pc.result_type == "VERIFICATION_NEEDED" and result.coordinates is defined and result.coordinates %}
            <a class="proximity-satellite-link"
               href="https://www.google.com/maps/@{{ result.coordinates.lat }},{{ result.coordinates.lng }},18z/data=!3m1!1e1"
               target="_blank" rel="noopener">View satellite imagery &rarr;</a>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <div class="proximity-item proximity-neutral">
        <div class="proximity-name">
          <span class="proximity-icon proximity-icon-clear">&#10003;</span>
          No environmental concerns detected near this address.
        </div>
      </div>
    {% endif %}

    {# â”€â”€ Road Noise Estimate card â”€â”€ #}
    {# Three-state guard: key absent â†’ old snapshot, hide card.           #}
    {# value=none â†’ Overpass failed / no roads, hide card.                #}
    {# value={..} â†’ show card with severity-based styling.                #}
    {% if result.road_noise is defined and result.road_noise %}
      {% set rn = result.road_noise %}
      {% set sev = rn.severity %}
      {% if sev == "VERY_LOUD" or sev == "LOUD" %}
        {% set noise_css = "proximity-very_close" %}
      {% elif sev == "MODERATE" %}
        {% set noise_css = "proximity-notable" %}
      {% else %}
        {% set noise_css = "proximity-neutral" %}
      {% endif %}
      <div class="proximity-item {{ noise_css }}">
        <div class="proximity-name">
          {% if sev == "QUIET" -%}
            <span class="proximity-icon proximity-icon-clear">&#10003;</span>
          {%- elif sev == "MODERATE" -%}
            <span class="proximity-icon proximity-icon-unverified">!</span>
          {%- else -%}
            <span class="proximity-icon proximity-icon-issue">&#10007;</span>
          {%- endif %}
          Road Noise Estimate
        </div>
        <div class="proximity-detail">{{ rn.severity_label }}</div>
        <div class="proximity-detail road-noise-detail">
          Estimated ~{{ "%.0f"|format(rn.estimated_dba) }} dBA from {{ rn.worst_road_name }}{% if rn.worst_road_ref %} ({{ rn.worst_road_ref }}){% endif %}, {{ "%.0f"|format(rn.distance_ft) }} ft away
        </div>
        <div class="collapsible-toggle road-noise-toggle" onclick="toggleSection(this)">
          <span class="collapse-icon road-noise-label">&#9654;</span>
          <span class="road-noise-label">About the estimate</span>
        </div>
        <div class="collapsible-body collapsed road-noise-methodology">
          {{ rn.methodology_note }}
        </div>
      </div>
    {% endif %}

    {# â”€â”€ Sidewalk & Cycleway Coverage card (NES-110) â”€â”€ #}
    {# Three-state guard: key absent â†’ old snapshot, hide card.           #}
    {# value=none â†’ Overpass failed / no roads, hide card.                #}
    {# value={..} â†’ show card with coverage data.                         #}
    {% if result.sidewalk_coverage is defined and result.sidewalk_coverage %}
      {% set sc = result.sidewalk_coverage %}
      {% if sc.data_confidence == "HIGH" %}
        {% if sc.sidewalk_pct >= 60 %}
          {% set sw_css = "proximity-neutral" %}
        {% elif sc.sidewalk_pct >= 30 %}
          {% set sw_css = "proximity-notable" %}
        {% else %}
          {% set sw_css = "proximity-very_close" %}
        {% endif %}
      {% else %}
        {% set sw_css = "proximity-neutral" %}
      {% endif %}
      <div class="proximity-item {{ sw_css }}">
        <div class="proximity-name">
          <span class="proximity-icon proximity-icon-clear">&#128694;</span>
          Sidewalk &amp; Cycleway Coverage
        </div>
        <div class="proximity-detail">
          {{ "%.0f"|format(sc.sidewalk_pct) }}% of nearby roads have sidewalks
          &bull; {{ "%.0f"|format(sc.cycleway_pct) }}% have cycling infrastructure
        </div>
        <div class="proximity-detail">
          {{ sc.total_road_segments }} road segments assessed within 500 m
          {% if sc.separate_cycleways > 0 %} &bull; {{ sc.separate_cycleways }} dedicated cycleway{{ "s" if sc.separate_cycleways != 1 }}{% endif %}
          {% if sc.separate_footways > 0 %} &bull; {{ sc.separate_footways }} dedicated sidewalk{{ "s" if sc.separate_footways != 1 }}{% endif %}
        </div>
        <div class="proximity-detail sidewalk-confidence sidewalk-confidence-{{ sc.data_confidence|lower }}">
          Data confidence: {{ sc.data_confidence }} &mdash; {{ sc.data_confidence_note }}
        </div>
        <div class="collapsible-toggle" onclick="toggleSection(this)">
          <span class="collapse-icon">&#9654;</span>
          <span>About this metric</span>
        </div>
        <div class="collapsible-body collapsed">
          {{ sc.methodology_note }}
        </div>
      </div>
    {% endif %}

  </div>

  {# â”€â”€ 6b. COMMUNITY PROFILE â€” shown in both preview and full (NES-134) â”€â”€ #}
  {# Three-state guard: key absent = old snapshot (hide),                     #}
  {#   value=none = API failure (hide), value=dict = show section.            #}
  {% if result.demographics is defined and result.demographics is not none %}
  <div id="community-profile" class="report-section">
    <h2>Community Profile</h2>

    {# Section-level narrative insight #}
    {% if result.insights is defined and result.insights and result.insights.community_profile %}
      <p class="section-insight">{{ result.insights.community_profile }}</p>
    {% endif %}

    {# Stat card grid #}
    {% set demo = result.demographics %}
    <div class="stat-card-grid">

      {# Households with children #}
      <div class="stat-card">
        <div class="stat-card__value">{{ "%.0f"|format(demo.children_pct) }}%</div>
        <div class="stat-card__label">Households with children</div>
        {% if demo.county_children_pct is not none %}
        <div class="stat-card__compare">{{ demo.county_name or "County" }}: {{ "%.0f"|format(demo.county_children_pct) }}%</div>
        {% endif %}
      </div>

      {# Renter-occupied #}
      <div class="stat-card">
        <div class="stat-card__value">{{ "%.0f"|format(demo.renter_pct) }}%</div>
        <div class="stat-card__label">Renter-occupied housing</div>
        {% if demo.county_renter_pct is not none %}
        <div class="stat-card__compare">{{ demo.county_name or "County" }}: {{ "%.0f"|format(demo.county_renter_pct) }}%</div>
        {% endif %}
      </div>

      {# Median rent #}
      {% if demo.median_rent is not none %}
      <div class="stat-card">
        <div class="stat-card__value">${{ "{:,}".format(demo.median_rent) }}</div>
        <div class="stat-card__label">Median gross rent</div>
        {% if demo.county_median_rent is not none %}
        <div class="stat-card__compare">{{ demo.county_name or "County" }}: ${{ "{:,}".format(demo.county_median_rent) }}</div>
        {% endif %}
      </div>
      {% endif %}

      {# Transit commuters #}
      {% if demo.commute and demo.commute.transit_pct >= 1 %}
      <div class="stat-card">
        <div class="stat-card__value">{{ "%.0f"|format(demo.commute.transit_pct) }}%</div>
        <div class="stat-card__label">Commute by transit</div>
        {% if demo.county_commute is not none and demo.county_commute.transit_pct is defined %}
        <div class="stat-card__compare">{{ demo.county_name or "County" }}: {{ "%.0f"|format(demo.county_commute.transit_pct) }}%</div>
        {% endif %}
      </div>
      {% endif %}

      {# Work from home #}
      {% if demo.commute and demo.commute.wfh_pct >= 5 %}
      <div class="stat-card">
        <div class="stat-card__value">{{ "%.0f"|format(demo.commute.wfh_pct) }}%</div>
        <div class="stat-card__label">Work from home</div>
      </div>
      {% endif %}

    </div>

    {# Data attribution #}
    <p class="community-profile-source">
      Source: U.S. Census Bureau, ACS 5-Year Estimates &middot; Tract {{ demo.geoid }}
    </p>

  </div>
  {% endif %}

  {# â”€â”€ NES-132: UPGRADE CTA â€” preview only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {% if is_preview %}
  <div class="preview-upgrade-cta">
    <h3>See the full livability report</h3>
    <p>Neighborhood map, transit access, parks &amp; green space, walkability scores, and more.</p>
    <button class="preview-unlock-btn" data-snapshot-id="{{ snapshot_id }}">
      Unlock full report &mdash; $9
    </button>
  </div>
  {% endif %}

  {# â”€â”€ 7. HOW WE SCORE â€” full report only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {% if not is_preview %}
  <div id="how-we-score" class="report-section">
    <div class="collapsible-toggle" onclick="toggleSection(this)">
      <h2>How We Score</h2>
      <span class="collapse-icon">&#9654;</span>
    </div>
    <div class="collapsible-body collapsed">

    <p class="scoring-explanation">
      NestCheck evaluates six daily-life factors, each scored 0â€“10.
      {% if result.persona is defined and result.persona and result.persona.key != 'balanced' %}
      With the <strong>{{ result.persona.label }}</strong> lens, dimensions
      are weighted to reflect that lifestyle.
      {% else %}
      The scores are combined and normalized to a 100-point scale.
      {% endif %}
      Bonus points (up to +15) may be added for parking, outdoor space, or extra bedrooms.
    </p>

    {% if result.persona is defined and result.persona and result.persona.weights and result.persona.key != 'balanced' %}
    <div class="persona-weights-table">
      {% for dim_name, weight in result.persona.weights.items() %}
      <div class="persona-weight-row">
        <span class="pw-dim">{{ dim_name }}</span>
        <span class="pw-weight {% if weight > 1.0 %}pw-emphasis{% elif weight < 1.0 %}pw-deemphasis{% endif %}">
          {% if weight > 1.0 %}+{{ "%.0f"|format((weight - 1.0) * 100) }}% weight
          {% elif weight < 1.0 %}-{{ "%.0f"|format((1.0 - weight) * 100) }}% weight
          {% else %}standard weight{% endif %}
        </span>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    {# Band thresholds must match SCORING_MODEL.score_bands in scoring_config.py #}
    <div class="band-table">
      <div class="band-row"><span class="band-dot band-exceptional"></span><span class="band-range">85â€“100</span><span class="band-label">Exceptional Daily Fit</span></div>
      <div class="band-row"><span class="band-dot band-strong"></span><span class="band-range">70â€“84</span><span class="band-label">Strong Daily Fit</span></div>
      <div class="band-row"><span class="band-dot band-moderate"></span><span class="band-range">55â€“69</span><span class="band-label">Moderate â€” Some Trade-offs</span></div>
      <div class="band-row"><span class="band-dot band-limited"></span><span class="band-range">40â€“54</span><span class="band-label">Limited â€” Car Likely Needed</span></div>
      <div class="band-row"><span class="band-dot band-poor"></span><span class="band-range">0â€“39</span><span class="band-label">Significant Gaps</span></div>
    </div>

    <p class="scoring-note">
      Proximity checks for gas stations and highways are safety flags that don't affect your numerical score.
      Road noise, estimated from nearby road proximity, does contribute to your score &mdash; quieter locations score higher.
    </p>

    </div>{# .collapsible-body #}
  </div>{# .report-section #}
  {% endif %}{# not is_preview #}

  {# â”€â”€ SHARE + EXPORT BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {% if not is_preview and snapshot_id %}
  <div class="share-bar">
    {% if is_snapshot and snapshot is defined %}
    <div class="snapshot-meta">
      Snapshot created {{ snapshot.created_at[:10] }}
      {% if snapshot.view_count > 1 %} Â· Viewed {{ snapshot.view_count }} times{% endif %}
    </div>
    {% endif %}
    <div class="share-actions">
      <button class="share-btn" id="nativeShareBtn" style="display:none" onclick="nativeShare()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
        <span>Share</span>
      </button>
      <button class="share-btn" id="shareBtn" onclick="copyShareLink(this)">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
        <span id="shareBtnText">Copy share link</span>
      </button>
      <button class="share-btn share-btn--secondary" onclick="window.print()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        Save as PDF
      </button>
      <a href="/api/snapshot/{{ snapshot_id }}/json" class="share-btn share-btn--secondary">JSON</a>
      <a href="/api/snapshot/{{ snapshot_id }}/csv" class="share-btn share-btn--secondary">CSV</a>
      {% if compare_index is not defined %}
      <button class="share-btn share-btn--secondary" id="compareAddBtn"
              data-snapshot-id="{{ snapshot_id | e }}"
              data-snapshot-address="{{ result.address | e }}">Add to comparison</button>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {# â”€â”€ CTA BANNER (snapshot only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {% if is_snapshot %}
  <div class="snapshot-cta">
    <h3>Wondering how your address compares?</h3>
    <p>Run the same evaluation on any U.S. address â€” walkability, green space, transit, safety proximity, and more.</p>
    <a href="/">Evaluate an Address</a>
  </div>
  {% endif %}

  {# â”€â”€ DISCLAIMER + DATA SOURCES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <div class="disclaimer">
    <strong>Disclaimer:</strong> NestCheck is a decision-support tool, not professional real estate, health, or legal advice.
    Scores are estimates based on publicly available data. Verify listing details, school assignments, and environmental conditions independently.
    <br><br>
    <strong>Data sources:</strong> Google Maps Platform (Places, Distance Matrix, Geocoding),
    OpenStreetMap via Overpass API (road classification, green space polygons, road geometry),
    Walk Score (when available), and FHWA Traffic Noise Model reference levels.
  </div>

</div>
