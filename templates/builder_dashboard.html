{% extends "_base.html" %}

{% block title %}NestCheck — Builder Dashboard{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block nav_links %}
  <a href="/" class="nav-link">Home</a>
{% endblock %}

{% block content %}
<div class="dashboard">
  <h1>Builder Dashboard</h1>

  <div class="dashboard-stat-grid">
    <div class="dashboard-stat">
      <div class="stat-num">{{ counts.get('snapshot_created', 0) }}</div>
      <div class="stat-lbl">Snapshots Created</div>
    </div>
    <div class="dashboard-stat">
      <div class="stat-num">{{ counts.get('snapshot_viewed', 0) }}</div>
      <div class="stat-lbl">Snapshot Views</div>
    </div>
    <div class="dashboard-stat">
      <div class="stat-num">{{ counts.get('snapshot_shared', 0) }}</div>
      <div class="stat-lbl">Share Clicks</div>
    </div>
    <div class="dashboard-stat">
      <div class="stat-num">{{ counts.get('return_visit', 0) }}</div>
      <div class="stat-lbl">Return Visits</div>
    </div>
    <div class="dashboard-stat dashboard-stat--error">
      <div class="stat-num">{{ counts.get('evaluation_error', 0) }}</div>
      <div class="stat-lbl">Errors</div>
    </div>
  </div>

  <h2>Recent Snapshots</h2>
  <div class="dashboard-card">
    <table class="dashboard-table">
      <tr>
        <th>ID</th>
        <th>Address</th>
        <th>Score</th>
        <th>Finding</th>
        <th>Views</th>
        <th>Created</th>
      </tr>
      {% for s in recent_snapshots %}
      <tr>
        <td><a href="/s/{{ s.snapshot_id }}">{{ s.snapshot_id }}</a></td>
        <td>{{ s.address_input[:50] }}{% if s.address_input|length > 50 %}...{% endif %}</td>
        <td>{{ s.final_score }}</td>
        <td>
          {% if s.key_finding_type and s.key_finding_type != 'neutral' %}
            <span class="badge-finding {% if s.key_finding_revealing %}badge-revealing{% else %}badge-normal{% endif %}">
              {{ s.key_finding_type | replace('_', ' ') }}
            </span>
          {% else %}
            —
          {% endif %}
        </td>
        <td>{{ s.view_count }}</td>
        <td>{{ s.created_at[:19] }}</td>
      </tr>
      {% endfor %}
      {% if not recent_snapshots %}
      <tr><td colspan="6" class="empty-row">No snapshots yet</td></tr>
      {% endif %}
    </table>
  </div>

  <h2>Recent Events</h2>
  <div class="dashboard-card">
    <table class="dashboard-table">
      <tr>
        <th>Event</th>
        <th>Snapshot</th>
        <th>Visitor</th>
        <th>Time</th>
      </tr>
      {% for e in recent_events %}
      <tr>
        <td>
          <span class="badge-event
            {% if e.event_type == 'snapshot_created' %}badge-created
            {% elif e.event_type == 'snapshot_viewed' %}badge-viewed
            {% elif e.event_type == 'snapshot_shared' %}badge-shared
            {% elif e.event_type == 'return_visit' %}badge-return
            {% else %}badge-error{% endif %}
          ">{{ e.event_type }}</span>
        </td>
        <td>{% if e.snapshot_id %}<a href="/s/{{ e.snapshot_id }}">{{ e.snapshot_id }}</a>{% else %}-{% endif %}</td>
        <td>{{ e.visitor_id[:8] if e.visitor_id else '-' }}...</td>
        <td>{{ e.created_at[:19] }}</td>
      </tr>
      {% endfor %}
      {% if not recent_events %}
      <tr><td colspan="4" class="empty-row">No events yet</td></tr>
      {% endif %}
    </table>
  </div>
</div>
{% endblock %}
